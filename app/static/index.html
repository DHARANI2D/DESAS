<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DESAS - Forensic Workstation</title>
    <link rel="icon" href="/icon.png" type="image/png">
    <script type="text/javascript" src="/eel.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --danger: #dc2626;
            --warning: #f59e0b;
            --success: #10b981;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.5;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .navbar {
            flex-shrink: 0;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .navbar h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--primary);
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .navbar-logo {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .container {
            flex: 1;
            width: 100%;
            padding: 0 40px;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 24px;
            box-sizing: border-box;
            overflow: hidden;
            /* Ensure container doesn't scroll itself, but allows children to */
            height: calc(100vh - 80px);
            /* Adjust for navbar */
            margin-top: 24px;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .sidebar-sticky {
            height: calc(100vh - 120px);
            overflow-y: auto;
            padding-right: 8px;
        }

        .verdict-banner.Benign {
            color: #166534;
        }

        .verdict-banner.Pending {
            color: var(--text-muted);
        }

        .score-val {
            font-size: 3.5rem;
            font-weight: 900;
            margin: 8px 0;
        }

        .verdict-label {
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border-radius: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            width: 100%;
            gap: 12px;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-main);
        }

        .btn-outline:hover {
            background: #f9fafb;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        h2 {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .module-grid {
            height: calc(100vh - 120px);
            overflow-y: auto;
            padding-right: 8px;
            display: grid;
            gap: 24px;
            scroll-behavior: smooth;
        }

        .indicator-item {
            padding: 12px;
            border-radius: 8px;
            background: #f9fafb;
            border: 1px solid var(--border);
            margin-bottom: 12px;
        }

        .progress-container {
            margin-bottom: 24px;
            display: none;
        }

        .progress-bar-bg {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.4s ease;
        }

        .progress-text {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .progress-steps {
            margin-top: 12px;
            font-size: 0.7rem;
            color: var(--text-muted);
            border-top: 1px dashed var(--border);
            padding-top: 12px;
        }

        .step-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
            opacity: 0.5;
            transition: opacity 0.3s;
        }

        .step-item.active {
            opacity: 1;
            color: var(--primary);
            font-weight: 700;
        }

        .step-item.done {
            opacity: 0.8;
            color: var(--success);
        }

        .step-item.done .step-icon::before {
            content: "‚úì";
        }

        .step-item.active .step-icon::before {
            content: "‚Ä¢";
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        .toolkit-nav {
            display: flex;
            gap: 12px;
            margin-right: auto;
            margin-left: 24px;
        }

        .toolkit-nav a {
            text-decoration: none;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.875rem;
            padding: 4px 12px;
            border-radius: 6px;
        }

        .toolkit-nav a.active {
            color: var(--primary);
            background: #eff6ff;
        }

        #drop-zone {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 9999;
            pointer-events: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
        }

        #drop-zone.active {
            display: flex;
        }

        .drop-area-box {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            color: var(--text-muted);
            background: #f9fafb;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .drop-area-box:hover,
        .drop-area-box.dragover {
            border-color: var(--primary);
            background: #eff6ff;
            color: var(--primary);
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .source-tag {
            font-size: 0.65rem;
            background: #f3f4f6;
            color: var(--text-muted);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        .category-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-weight: 700;
            margin: 32px 0 16px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .category-label::after {
            content: "";
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
            margin-top: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th {
            background: #f9fafb;
            padding: 10px;
            text-align: left;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.875rem;
        }

        .toolkit-dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            width: 100%;
        }

        .tool-card {
            background: white;
            padding: 16px;
            border-radius: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .standalone-input {
            width: 100%;
            padding: 10px;
            font-size: 0.875rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-sizing: border-box;
        }

        textarea.standalone-input {
            min-height: 80px;
            resize: vertical;
        }

        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid #e5e7eb;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-bg);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 28px;
            padding: 40px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
        }

        /* Settings Cards & Form Groups */
        .settings-card {
            background: #ffffff;
            border: 1px solid #f1f5f9;
            border-radius: 20px;
            padding: 24px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .settings-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        }

        .settings-form-group {
            margin-bottom: 24px;
        }

        .settings-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #64748b;
            margin-bottom: 8px;
            letter-spacing: 0.05em;
        }

        .settings-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            font-size: 0.9rem;
            transition: all 0.2s;
            background: #f8fafc;
            box-sizing: border-box;
        }

        .settings-input:focus {
            outline: none;
            border-color: var(--primary);
            background: #ffffff;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .whitelist-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .whitelist-table th {
            text-align: left;
            padding: 12px;
            background: #f1f5f9;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-muted);
            border-bottom: 2px solid var(--border);
        }

        .whitelist-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        .whitelist-item-row {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            background: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 4px;
        }

        .whitelist-item-row:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-color: var(--primary);
            z-index: 10;
            position: relative;
        }

        .drop-zone-mini {
            border: 2px dashed #cbd5e1;
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            color: #64748b;
            margin-bottom: 24px;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8fafc;
        }

        .drop-zone-mini:hover,
        .drop-zone-mini.dragover {
            border-color: var(--primary);
            background: #eff6ff;
            color: var(--primary);
        }


        .role-btn {
            flex: 1;
            border: none;
            padding: 6px;
            font-size: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            background: transparent;
            font-weight: 600;
            color: var(--text-muted);
        }

        .role-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .malicious-summary-alert {
            background: #fef2f2;
            border-left: 4px solid var(--danger);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            display: none;
        }

        .domain-sidebar-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s;
            margin-bottom: 4px;
            border: 1px solid transparent;
        }

        .domain-sidebar-item:hover {
            background: #f1f5f9;
            border-color: var(--border);
        }

        /* Export Modal Styles */
        .modal-body {
            padding: 24px;
            text-align: center;
        }

        .export-option-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 24px;
        }

        .export-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-btn:hover {
            border-color: var(--primary);
            background: #eff6ff;
            transform: translateY(-2px);
        }

        .export-btn img {
            width: 40px;
            height: 40px;
        }

        .export-btn span {
            font-weight: 700;
            font-size: 0.875rem;
        }
    </style>
</head>

<body>
    <div id="drop-zone">
        <div style="font-size: 5rem; margin-bottom: 20px;">üìÇ</div>
        <div style="font-size: 1.5rem; font-weight: 800;">Drop Email File Here</div>
    </div>

    <nav class="navbar">
        <div style="display: flex; align-items: center;">
            <h1 style="cursor: pointer; display: flex; align-items: center; gap: 12px;" onclick="location.reload()">
                <img src="/icon.png" alt="" class="navbar-logo">
                DESAS
            </h1>
            <div class="toolkit-nav">
                <a href="#" id="navAnalysis" class="active" onclick="showSection('analysis')">Full Analysis</a>
                <a href="#" id="navToolkit" onclick="showSection('toolkit')">Forensic Toolkit</a>
            </div>
        </div>
        <div style="display:flex; gap:12px; align-items:center;">
            <button class="btn btn-outline" id="newAnalysisBtn" onclick="handleNewAnalysis()"
                style="width:auto; margin:0; display:flex; align-items:center; gap:8px; border-color:#e2e8f0; background:#f8fafc;">
                <span>‚ûï</span> New Analysis
            </button>
            <button class="btn btn-outline" id="downloadReportBtn" onclick="generateReport()"
                style="width: auto; margin: 0; display: flex; align-items: center; gap: 8px;">
                <img src="https://img.icons8.com/ios-filled/50/2563eb/download-mail.png" style="width: 16px;"> Download
                Report
            </button>
            <button class="btn btn-outline" onclick="openSettingsModal()"
                style="width: auto; margin: 0; display:flex; align-items:center; gap:8px;">
                <span>‚öôÔ∏è</span> Settings & Whitelist
            </button>
        </div>
    </nav>

    <!-- EXPORT MODAL -->
    <div id="exportModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="font-size: 1.5rem; letter-spacing: -0.01em;">üì¶ Export Forensic Report</h2>
                <button onclick="closeModal('exportModal')"
                    style="background:#f1f5f9; border:none; width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--text-muted); transition:all 0.2s;">‚úï</button>
            </div>
            <p style="color: var(--text-muted); font-size: 1rem; margin-bottom: 32px;">Select your preferred format for
                the investigation report.</p>

            <div class="export-option-grid" style="gap: 20px;">
                <div class="export-btn" onclick="exportReport('html')" style="padding: 24px;">
                    <img src="https://img.icons8.com/color/96/html-5--v1.png" alt="HTML">
                    <span style="font-size: 0.9rem;">HTML Report</span>
                </div>
                <div class="export-btn" onclick="exportReport('pdf')" style="padding: 24px;">
                    <img src="https://img.icons8.com/color/96/pdf.png" alt="PDF">
                    <span style="font-size: 0.9rem;">PDF Document</span>
                </div>
                <div class="export-btn" onclick="exportReport('both')" style="padding: 24px;">
                    <img src="https://img.icons8.com/color/96/archive.png" alt="Both">
                    <span style="font-size: 0.9rem;">Both Formats</span>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS & WHITELIST MODAL -->
    <div id="settingsModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
                <div style="display:flex; align-items:center; gap:20px;">
                    <div
                        style="background:var(--primary); color:white; width:56px; height:56px; display:flex; align-items:center; justify-content:center; border-radius:18px; font-size:1.75rem; box-shadow: 0 8px 16px rgba(37, 99, 235, 0.2);">
                        ‚öôÔ∏è</div>
                    <div>
                        <h2 style="font-size: 2rem; margin:0; letter-spacing:-0.03em;">Workstation Configuration</h2>
                        <p style="margin:4px 0 0 0; font-size: 0.9rem; color: var(--text-muted); font-weight: 500;">
                            Manage API ecosystem and threat intelligence trust</p>
                    </div>
                </div>
                <button onclick="closeModal('settingsModal')"
                    style="background:#f1f5f9; border:none; width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--text-muted); transition:all 0.2s;">‚úï</button>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1.2fr; gap: 48px;">
                <!-- Left: API Config -->
                <div class="settings-card" style="padding: 32px; border-radius: 24px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                        <h3 style="font-size: 1.25rem; margin:0; font-weight:800; color:var(--text-main);">üîë API
                            Ecosystem</h3>
                        <button type="button" class="btn btn-outline" onclick="useDefaultSettings()"
                            style="width: auto; padding: 6px 16px; font-size: 0.75rem; border-radius:10px; color:var(--text-muted);">Default
                            Reset</button>
                    </div>

                    <div class="drop-zone-mini" id="apiDropZone" style="padding: 40px; border-radius: 20px;">
                        <div style="font-size: 2rem; margin-bottom: 12px;">üìë</div>
                        <div style="font-weight: 700; font-size: 0.95rem;">Import keys from file</div>
                        <div style="font-size: 0.8rem; opacity: 0.6; margin-top:6px;">Drag & drop API.txt</div>
                    </div>
                    <input type="file" id="apiFileInput" accept=".txt" style="display: none;">

                    <form id="settingsForm">
                        <div class="settings-form-group">
                            <label class="settings-label">VirusTotal Intelligence</label>
                            <input type="password" id="vt_key" class="settings-input"
                                placeholder="Paste VT endpoint key">
                        </div>
                        <div class="settings-form-group">
                            <label class="settings-label">MxToolbox Forensic</label>
                            <input type="password" id="mxtoolbox_key" class="settings-input"
                                placeholder="Paste MxToolbox key">
                        </div>
                        <div class="settings-form-group">
                            <label class="settings-label">AbuseIPDB Reputation</label>
                            <input type="password" id="abuse_key" class="settings-input"
                                placeholder="Paste AbuseIPDB key">
                        </div>
                        <button type="submit" class="btn btn-primary" id="saveSettingsBtn"
                            style="height:56px; font-size:1rem; border-radius: 16px; box-shadow:0 8px 20px rgba(37, 99, 235, 0.25);">Deploy
                            Configuration</button>
                    </form>
                    <div id="settingsSaveStatus"
                        style="margin-top: 20px; font-size: 0.85rem; text-align: center; display: none; font-weight:700;">
                    </div>
                </div>

                <!-- Right: Whitelist -->
                <div class="settings-card"
                    style="padding: 32px; border-radius: 24px; display:flex; flex-direction:column;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                        <h3 style="font-size: 1.25rem; margin:0; font-weight:800; color:var(--text-main);">üõ°Ô∏è Trusted
                            Identities</h3>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn btn-outline"
                                style="width: auto; padding: 8px 16px; font-size: 0.8rem; border-radius:10px;"
                                onclick="exportWhitelist()">Export</button>
                            <button class="btn btn-outline"
                                style="width: auto; padding: 8px 16px; font-size: 0.8rem; border-radius:10px;"
                                onclick="document.getElementById('xlImportInput').click()">Import</button>
                        </div>
                    </div>

                    <input type="file" id="xlImportInput" accept=".xlsx,.txt" style="display: none;"
                        onchange="importWhitelist(this)">

                    <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                        <input type="text" id="newWhitelistDomain" class="settings-input"
                            placeholder="Target domain to trust..." style="background:#fff; border-radius: 16px;">
                        <button class="btn btn-primary"
                            style="width: 56px; height:56px; padding:0; display:flex; align-items:center; justify-content:center; font-size:1.5rem; flex-shrink:0; border-radius: 16px;"
                            onclick="addDomainManual()">+</button>
                    </div>

                    <div style="position:relative; margin-bottom: 16px;">
                        <input type="text" id="whitelistModalSearch" class="settings-input"
                            placeholder="Search identities..." oninput="filterWhitelistModal(this.value)"
                            style="padding-left:48px; background:#fff; border-radius: 16px;">
                        <span
                            style="position:absolute; left:18px; top:50%; transform:translateY(-50%); opacity:0.4; font-size: 1.1rem;">üîç</span>
                    </div>

                    <div id="whitelistModalTableBody"
                        style="flex:1; max-height: 400px; overflow-y: auto; border: 1px solid #f1f5f9; border-radius: 16px; background:#fafafa; padding: 12px;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API CHECK MODAL -->
    <div id="apiCheckModal" class="modal" style="z-index: 2000;">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <div style="font-size: 4rem; margin-bottom: 16px;">üîë</div>
            <h2 style="font-size: 1.5rem; margin-bottom: 12px; letter-spacing: -0.01em;">API Configuration Required</h2>
            <p style="color: var(--text-muted); font-size: 1rem; margin-bottom: 32px; line-height: 1.5;">
                To unlock full forensic capabilities, please configure your API keys. You can skip this for now, but
                functionality will be limited.
            </p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button class="btn btn-primary" onclick="openSettingsModal(); closeModal('apiCheckModal');"
                    style="width: auto; padding: 12px 24px; font-size: 1rem; border-radius: 12px;">Configure
                    Now</button>
                <button class="btn btn-outline" onclick="closeModal('apiCheckModal')"
                    style="width: auto; padding: 12px 24px; font-size: 1rem; border-radius: 12px; border:none; color:var(--text-muted);">Skip
                    for now</button>
            </div>
        </div>
    </div>

    <!-- FULL ANALYSIS SECTION -->
    <div class="container" id="analysisSection">
        <aside class="sidebar-sticky">
            <div class="card"
                style="padding: 0; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 240px;">
                <div id="sidebarVerdictBox" class="verdict-banner Pending" style="margin:0; padding:40px 0;">
                    <div id="sidebarVerdictText" class="verdict-label" style="font-size: 1.25rem; font-weight:900;">üîç
                        READY</div>
                    <div id="threatBadge" class="badge" style="margin-top: 12px; display: none;"></div>
                </div>

                <div style="padding: 24px;">
                    <div id="fullAnalysisProgress" class="progress-container">
                        <div class="progress-text">
                            <span id="pbStatus" style="font-weight:700;">Ready...</span>
                            <span id="pbPercent">0%</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div id="pbFill" class="progress-bar-fill"></div>
                        </div>
                        <div id="cancelAnalysisBtn" style="display:none; text-align:center; margin-top:8px;">
                            <button class="btn"
                                style="background:#fee2e2; color:#991b1b; font-size:0.65rem; padding:4px 12px;"
                                onclick="cancelAnalysis()">‚úï Cancel Analysis</button>
                        </div>
                        <div id="progressSteps" class="progress-steps">
                            <div class="step-item" id="step_init"><span class="step-icon"></span> Initializing</div>
                            <div class="step-item" id="step_parse"><span class="step-icon"></span> Headers</div>
                            <div class="step-item" id="step_nlp"><span class="step-icon"></span> Content</div>
                            <div class="step-item" id="step_intel"><span class="step-icon"></span> Intelligence</div>
                            <div class="step-item" id="step_sandbox"><span class="step-icon"></span> Sandbox</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label
                            style="font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; display: block;">Mail
                            Type</label>
                        <div id="analysisModeSelector"
                            style="display: flex; background: #f1f5f9; border-radius: 8px; padding: 4px; gap: 4px;">
                            <button id="modeDirect" class="role-btn active" onclick="setAnalysisMode('direct')">üìß
                                Direct</button>
                            <button id="modeForensic" class="role-btn" onclick="setAnalysisMode('forensic')">üîç
                                Proofpoint</button>
                        </div>
                    </div>

                    <div class="drop-area-box" id="sidebarDropArea"
                        onclick="document.getElementById('fileInput').click()">
                        <div style="font-size: 2rem; margin-bottom: 8px;">üì•</div>
                        <div style="font-weight: 700; font-size: 0.875rem;">Click to upload</div>
                        <div style="font-size: 0.75rem; opacity: 0.7;">or Drag & Drop email here</div>
                    </div>
                    <input type="file" id="fileInput" accept=".eml,.msg" style="display: none;" onchange="handleFile()">

                    <div id="emailMetadata"
                        style="margin-top: 24px; border-top: 1px solid var(--border); padding-top: 20px; display: none;">
                        <h3
                            style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 12px; font-weight:800;">
                            üìß Case Metadata</h3>
                        <div style="font-size: 0.8rem; margin-bottom: 6px;"><strong>Subject:</strong> <span
                                id="metaSubject"></span></div>
                        <div style="font-size: 0.8rem; margin-bottom: 6px;"><strong>Sender:</strong> <span
                                id="metaSender"></span></div>
                        <div style="font-size: 0.8rem; margin-bottom: 6px;"><strong>Recipient:</strong> <span
                                id="metaRecipient"></span></div>
                        <div style="font-size: 0.8rem; margin-bottom: 6px;"><strong>Time:</strong> <span
                                id="metaDate"></span></div>
                        <div style="font-size: 0.8rem;"><strong>Attachments:</strong> <span
                                id="metaAttachments">0</span></div>
                    </div>

                    <div id="egressedDomainsSection"
                        style="margin-top: 24px; border-top: 1px dashed var(--border); padding-top: 20px; display: none;">
                        <h3
                            style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 12px; font-weight:800;">
                            üåê Egress Inventory</h3>
                        <div id="egressedDomainsList"
                            style="display: grid; grid-template-columns: 1fr; gap: 4px; max-height: 200px; overflow-y: auto; padding-right: 4px;">
                            <!-- Items injected by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- CRASH ERROR SECTION (Non-destructive overlay) -->
        <div id="crashErrorSection"
            style="display: none; max-width: 800px; margin: 40px auto; padding: 48px; text-align: center; background: #fff1f2; border: 1px solid #fecaca; border-radius: 12px;">
            <div style="font-size: 3rem; margin-bottom: 16px;">‚ö†Ô∏è</div>
            <h2 style="color: #991b1b; margin-bottom: 12px;">Workstation Crash Detected</h2>
            <p style="color: #7f1d1d; font-size: 0.875rem; margin-bottom: 24px;">The analysis was interrupted by an
                internal error. This is often caused by malformed headers or lost connectivity.</p>
            <div id="crashErrorMessage"
                style="background: #ffffff; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 0.75rem; text-align: left; border: 1px solid #fca5a5; margin-bottom: 24px; word-break: break-all;">
            </div>
            <button class="btn btn-primary" onclick="resetUI()">üîÑ Reset Workstation</button>
        </div>

        <!-- MAIN GRID CONTAINER -->
        <main class="module-grid" id="mainResults">
            <!-- WELCOME / READY LOCAL STATE -->
            <div id="welcomeCard"
                style="display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: var(--text-muted); opacity: 0.6; min-height: 200px; grid-column: 1 / -1; width: 100%; margin-top: 40px;">
                <div style="font-size: 3rem; margin-bottom: 8px;">üîç</div>
                <h2 style="margin: 0; font-size: 1.25rem; color: var(--text-muted);">Ready to Analyze</h2>
                <p style="margin: 4px 0 0 0; font-size: 0.9rem;">Upload an email file to begin forensic investigation.
                </p>
            </div>

            <!-- Malicious Hits Summary -->
            <div id="maliciousSummary" class="malicious-summary-alert">
                <div style="display: flex; gap: 12px; align-items: center;">
                    <span style="font-size: 1.5rem;">üö®</span>
                    <div>
                        <strong style="color: var(--danger); font-size: 0.9rem;">Critical Threats Identified</strong>
                        <div id="maliciousHitsList" style="font-size: 0.8rem; margin-top: 4px; color: #7f1d1d;"></div>
                    </div>
                </div>
            </div>

            <!-- Case Snapshot & Egress Inventory (REMOVED - MOVED TO SIDEBAR) -->
            <!-- Analysis Content Container -->
            <div id="reportContent" style="display:none; grid-column: 1 / -1; width: 100%;">

                <!-- Header Forensics Card -->
                <section class="card">
                    <div class="section-header" style="border-bottom:none; margin-bottom:12px;">
                        <h2>
                            <img src="https://img.icons8.com/ios/50/2563eb/email-header.png" style="width:20px;">
                            Header Forensics üõ°Ô∏è
                        </h2>
                        <button class="btn btn-outline" style="width:auto; padding:4px 12px; font-size:0.7rem;"
                            onclick="toggleTechnicalHeaders()">üîç Technical Details</button>
                    </div>
                    <div id="technicalHeadersContent"
                        style="display:none; margin-bottom:24px; padding:16px; background:#1e293b; color:#cbd5e1; border-radius:8px; font-family:monospace; font-size:0.7rem; max-height:300px; overflow-y:auto; white-space:pre-wrap;">
                    </div>

                    <div
                        style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 24px; margin-bottom: 24px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid var(--border);">
                        <div>
                            <h4
                                style="font-size: 0.7rem; font-weight:800; color:var(--text-muted); text-transform:uppercase; margin-bottom:12px;">
                                Authentication üîê</h4>
                            <div id="headerAuthIcons" style="display: flex; gap: 12px;">
                                <!-- Icons injected by JS -->
                            </div>
                        </div>
                        <div>
                            <h4
                                style="font-size: 0.7rem; font-weight:800; color:var(--text-muted); text-transform:uppercase; margin-bottom:12px;">
                                Infrastructure IP üåê</h4>
                            <div id="senderReputationBox" style="font-size: 0.8rem; color: var(--text-muted);">
                                Awaiting analysis...
                            </div>
                        </div>
                    </div>

                    <h4 style="font-size: 0.75rem; color:var(--text-muted); margin: 0 0 12px 0; font-weight:700;">
                        Routing
                        Hops</h4>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>HOP</th>
                                    <th>DELAY</th>
                                    <th>SOURCE / IP</th>
                                    <th>SECURITY INTEL</th>
                                    <th>TIMESTAMP</th>
                                </tr>
                            </thead>
                            <tbody id="headerHopsTableBody">
                                <tr>
                                    <td colspan="5"
                                        style="text-align:center; color:var(--text-muted); padding:32px; font-size:0.8rem;">
                                        No routing hops detected.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Content & NLP Card -->
                <section class="card" style="margin-top: 24px;">
                    <div class="section-header" style="border-bottom:none; margin-bottom:12px;">
                        <h2>
                            <img src="https://img.icons8.com/ios/50/2563eb/document.png" style="width:20px;">
                            Content & NLP üìù
                        </h2>
                    </div>

                    <div style="margin-top:12px; border-top:1px solid var(--border); padding-top:16px;">
                        <h4
                            style="font-size: 0.7rem; font-weight:800; color:var(--text-muted); text-transform:uppercase; margin-bottom:12px;">
                            Intelligence Results (VirusTotal) üõ°Ô∏è</h4>
                        <div class="table-responsive">
                            <table style="width: 100%; min-width: 900px;">
                                <thead>
                                    <tr>
                                        <th style="width:100px;">TYPE</th>
                                        <th>ARTIFACT</th>
                                        <th style="width:80px;">VT HITS</th>
                                        <th style="width:180px;">REGISTRAR / AGE</th>
                                        <th style="width:250px;">CATEGORIES / TAGS</th>
                                    </tr>
                                </thead>
                                <tbody id="intelTableBody">
                                    <tr>
                                        <td colspan="5"
                                            style="text-align:center; color:var(--text-muted); padding:32px; font-size:0.8rem;">
                                            Awaiting URL/Domain intelligence analysis...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div style="margin-top:24px; padding-top:16px; border-top:1px dashed var(--border);">
                        <h4
                            style="font-size: 0.7rem; font-weight:800; color:var(--text-muted); text-transform:uppercase; margin-bottom:12px;">
                            NLP Insights üß†</h4>
                        <div id="nlpInsightsList" style="font-size:0.8rem; color:var(--text-muted);">Awaiting semantic
                            analysis...</div>
                    </div>

                    <div
                        style="margin-top:24px; padding:16px; background:#f8fafc; border-radius:8px; border:1px solid var(--border);">
                        <h4
                            style="font-size: 0.7rem; font-weight:800; color:var(--text-muted); text-transform:uppercase; margin-bottom:12px;">
                            Infrastructure Features ‚öôÔ∏è</h4>
                        <div id="jsIndicatorList"
                            style="font-size:0.75rem; color:var(--text-muted); margin-bottom:12px;">No
                            JS indicators detected.</div>
                        <div id="detectedFormsList" style="font-size:0.75rem; color:var(--text-muted);">No interactive
                            forms
                            detected.</div>
                    </div>

                    <div style="margin-top:24px;">
                        <h4
                            style="font-size: 0.7rem; font-weight:800; color:var(--text-muted); text-transform:uppercase; margin-bottom:12px;">
                            File Analysis üì¶</h4>
                        <div id="attachmentsList" style="font-size:0.8rem; color:var(--text-muted);">No attachments to
                            analyze.</div>
                    </div>
                </section>

                <!-- Sandbox Detonation Section -->
                <div class="category-label" style="display:flex; align-items:center; gap:8px; margin-top: 24px;">
                    <img src="https://img.icons8.com/ios/50/2563eb/microscope.png" style="width:16px;">
                    Sandbox Detonation üî¨
                </div>

                <div id="sandboxResultsGrid" style="display: grid; grid-template-columns: 1fr; gap: 24px;">
                    <div id="noSandboxMsg"
                        style="padding: 64px; text-align: center; background: white; border-radius: 12px; border: 1px dashed var(--border); color: var(--text-muted);">
                        <div style="font-size:2rem; margin-bottom:12px;">üî¨</div>
                        <div>Awaiting URL extraction for sandbox detonation.</div>
                    </div>
                </div>
            </div>
        </main>

    </div>

    <!-- FORENSIC TOOLKIT SECTION -->
    <div id="toolkitSection" style="display: none; padding: 24px 40px;">
        <div class="toolkit-dashboard">
            <div class="tool-card" style="grid-column: span 2;">
                <h3><span>üìß Header Analyzer</span></h3>
                <textarea id="standaloneHeaderInput" class="standalone-input" placeholder="Paste full email headers..."
                    style="min-height: 120px;"></textarea>
                <button class="btn btn-primary" onclick="analyzeToolkit('header')">Analyze Headers</button>
            </div>
            <div class="tool-card">
                <h3><span>üìé File Analysis</span></h3>
                <div class="drop-area-box" onclick="document.getElementById('toolkitFileInput').click()"
                    style="margin:0; flex:1; display:flex; flex-direction:column; justify-content:center;">
                    <div style="font-size: 1.5rem;">üìé</div>
                    <div style="font-size: 0.75rem; font-weight:700;">Drop or Click</div>
                </div>
                <input type="file" id="toolkitFileInput" style="display: none;" onchange="analyzeToolkit('attachment')">
            </div>
            <div class="tool-card">
                <h3><span>üîó URL Sandbox</span></h3>
                <input type="text" id="standaloneUrlInput" class="standalone-input"
                    placeholder="https://suspicious-link.com">
                <button class="btn btn-primary" onclick="analyzeToolkit('url')">Detonate URL</button>
            </div>
            <div class="tool-card">
                <h3><span>üåê Domain Check</span></h3>
                <input type="text" id="standaloneDomainInput" class="standalone-input" placeholder="evil-domain.cc">
                <button class="btn btn-primary" onclick="analyzeToolkit('domain')">Check Domain</button>
            </div>
            <div class="tool-card">
                <h3><span>üõ°Ô∏è IP reputation</span></h3>
                <input type="text" id="standaloneIpInput" class="standalone-input" placeholder="1.2.3.4">
                <button class="btn btn-primary" onclick="analyzeToolkit('ip')">Check IP</button>
            </div>
        </div>

        <div id="toolkitResults" class="card" style="margin-top: 24px; display: none;">
            <div class="section-header">
                <h2>Toolkit Results</h2>
                <button class="btn btn-outline"
                    style="width: auto; height: 24px; padding: 0 8px; margin: 0; font-size: 0.7rem;"
                    onclick="document.getElementById('toolkitResults').style.display='none'">Clear</button>
            </div>
            <div id="toolkitResultsContent"></div>
        </div>
    </div>

    <!-- ATTACHMENT MODAL -->
    <div id="attachmentModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="font-size: 1.5rem; letter-spacing: -0.01em;">üì¶ Artifact Selection</h2>
                <button onclick="closeModal('attachmentModal')"
                    style="background:#f1f5f9; border:none; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--text-muted); transition:all 0.2s;">‚úï</button>
            </div>
            <p style="font-size: 1rem; color: var(--text-muted); margin-bottom: 32px;">Select the artifacts for deep
                forensic analysis.</p>

            <div class="table-container"
                style="max-height: 400px; overflow-y: auto; border:none; background:transparent; margin-bottom:32px;">
                <table style="border-collapse: separate; border-spacing: 0 12px; width:100%;">
                    <tbody id="attachmentTableBody"></tbody>
                </table>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <button class="btn btn-primary" onclick="confirmForensicSelection()"
                    style="height:56px; font-size:1.1rem;">üöÄ Run Analysis</button>
                <button class="btn btn-outline" style="height:56px; font-size:1.1rem; margin:0;"
                    onclick="closeModal('attachmentModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- PLAYWRIGHT INSTALL MODAL -->
    <div id="playwrightModal" class="modal" style="z-index: 2100;">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <div style="font-size: 4rem; margin-bottom: 16px;">üß©</div>
            <h2 style="font-size: 1.5rem; margin-bottom: 12px; letter-spacing: -0.01em;">Forensic Engine Setup</h2>
            <p style="color: var(--text-muted); font-size: 1rem; margin-bottom: 24px; line-height: 1.5;">
                To enable advanced sandbox detonation, the forensic browser engine (Chromium) must be installed.
            </p>
            <div id="pwInstallStatus" style="margin-bottom:24px; font-weight:700; color:var(--primary); display:none;">
                <div class="loader" style="margin:0 auto 12px auto;"></div>
                Installing... This may take a few minutes.
            </div>
            <button id="pwInstallBtn" class="btn btn-primary" onclick="installPlaywright()"
                style="width: 100%; padding: 16px; font-size: 1.1rem; border-radius: 12px;">Install Component</button>
        </div>
    </div>

    <script>
        let currentAnalysisMode = 'direct';
        let currentSessionId = null;
        let selectedTargetAtt = null;
        let selectedHeaderAtt = null;

        async function installPlaywright() {
            const btn = document.getElementById('pwInstallBtn');
            const status = document.getElementById('pwInstallStatus');
            btn.style.display = 'none';
            status.style.display = 'block';

            try {
                const res = await eel.install_playwright_browsers()();
                if (res.status === 'success') {
                    document.getElementById('playwrightModal').style.display = 'none';
                    showToast("‚úÖ Forensic Engine installed successfully");
                } else {
                    status.innerHTML = `<span style="color:var(--danger)">Error: ${res.message}</span>`;
                    btn.innerText = "Retry Install";
                    btn.style.display = 'block';
                }
            } catch (e) {
                status.innerHTML = `<span style="color:var(--danger)">Error: ${e}</span>`;
                btn.style.display = 'block';
            }
        }

        window.onload = async () => {
            console.log('DESAS initialized üöÄ');
            try {
                // Check Playwright
                const pwInstalled = await eel.check_playwright_status()();
                if (!pwInstalled) {
                    document.getElementById('playwrightModal').style.display = 'flex';
                }

                const settings = await eel.get_app_settings()();
                if (!settings || (!settings.VIRUSTOTAL_API_KEY && !settings.ABUSEIPDB_API_KEY)) {
                    // Only show API check if PW check is passed or closed, to avoid stacking
                    if (pwInstalled) document.getElementById('apiCheckModal').style.display = 'flex';
                }
                // Pre-load global whitelist for real-time marking
                await loadWhitelistInModal();
            } catch (e) {
                console.error("Failed to check startup requirements:", e);
            }
        };

        function showSection(section) {
            document.getElementById('analysisSection').style.display = section === 'analysis' ? 'grid' : 'none';
            document.getElementById('toolkitSection').style.display = section === 'toolkit' ? 'block' : 'none';
            document.getElementById('navAnalysis').className = section === 'analysis' ? 'active' : '';
            document.getElementById('navToolkit').className = section === 'toolkit' ? 'active' : '';
        }

        let isAnalysisInProgress = false;

        function resetUI() {
            // Instant reset without reload
            isAnalysisInProgress = false;
            currentAnalysisData = null;

            // Progress Bar
            const pb = document.getElementById('fullAnalysisProgress');
            pb.style.display = 'none';
            document.getElementById('pbFill').style.width = '0%';
            document.getElementById('pbFill').style.background = 'var(--primary)';
            document.getElementById('pbStatus').innerText = 'Ready...';
            document.getElementById('pbPercent').innerText = '0%';

            document.querySelectorAll('.step-item').forEach(s => s.className = 'step-item');

            // Metadata & Sections
            document.getElementById('emailMetadata').style.display = 'none';
            document.getElementById('egressedDomainsSection').style.display = 'none';
            // document.getElementById('mainResults').style.display = 'none'; // Don't hide the grid, just reset content
            document.getElementById('mainResults').style.display = 'grid';

            // Show Welcome Card
            const welcome = document.getElementById('welcomeCard');
            if (welcome) welcome.style.display = 'flex';

            // Hide other results manually if needed, or rely on them being empty/hidden by render
            const summary = document.getElementById('maliciousSummary');
            if (summary) summary.style.display = 'none';

            // IMPORTANT: Hide the Report Content
            const reportContent = document.getElementById('reportContent');
            if (reportContent) reportContent.style.display = 'none';

            // Force view back to analysis
            showSection('analysis');

            // Sidebar Verdict
            const verdictBox = document.getElementById('sidebarVerdictBox');
            const verdictText = document.getElementById('sidebarVerdictText');
            const threatBadge = document.getElementById('threatBadge');

            verdictBox.className = 'verdict-banner Pending';
            verdictText.innerText = 'üîç READY';
            threatBadge.style.display = 'none';

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Clear inputs
            const fileInput = document.getElementById('fileInput');
            if (fileInput) fileInput.value = '';

            // Hide Crash Section
            const crashSec = document.getElementById('crashErrorSection');
            if (crashSec) crashSec.style.display = 'none';

            showToast('Workstation reset complete.');
        }

        function handleNewAnalysis() {
            if (isAnalysisInProgress) {
                if (confirm("Analysis is already running. Reset workstation?")) {
                    resetUI();
                }
            } else {
                resetUI();
            }
        }

        function cancelAnalysis() {
            resetUI();
        }

        function setAnalysisMode(mode) {
            currentAnalysisMode = mode;
            document.getElementById('modeDirect').className = mode === 'direct' ? 'role-btn active' : 'role-btn';
            document.getElementById('modeForensic').className = mode === 'forensic' ? 'role-btn active' : 'role-btn';
        }

        async function handleFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Content = e.target.result.split(',')[1];
                updateProgress(10, "Initializing...", "step_init");

                if (currentAnalysisMode === 'forensic') {
                    updateProgress(20, "Inspecting container...", "step_init");
                    const data = await eel.inspect_email_file(file.name, base64Content)();
                    currentSessionId = data.session_id;
                    if (data.attachments && data.attachments.length > 0) {
                        showAttachmentModal(data.attachments);
                    } else {
                        runFinalAnalysis(file.name, base64Content);
                    }
                } else {
                    runFinalAnalysis(file.name, base64Content);
                }
            };
            reader.readAsDataURL(file);
        }

        function showAttachmentModal(attachments) {
            const body = document.getElementById('attachmentTableBody');
            body.innerHTML = '';
            selectedTargetAtt = null;
            selectedHeaderAtt = null;

            attachments.forEach((att, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:700; padding:16px 20px; border-radius:16px 0 0 16px; background:#f8fafc; border:1px solid #f1f5f9; border-right:none;">${att.filename}</td>
                    <td style="padding:16px 20px; background:#f8fafc; border:1px solid #f1f5f9; border-left:none; border-right:none; color:var(--text-muted); font-size:0.85rem;">${(att.size / 1024).toFixed(1)} KB</td>
                    <td style="padding:16px 20px; border-radius:0 16px 16px 0; background:#f8fafc; border:1px solid #f1f5f9; border-left:none; text-align:right;">
                        <div style="display:inline-flex; background:#f1f5f9; border-radius:12px; padding:3px; gap:4px;">
                            <button class="role-btn" style="min-width:70px;" onclick="setAttRole('${att.filename}', 'target', this)">Target</button>
                            <button class="role-btn" style="min-width:70px;" onclick="setAttRole('${att.filename}', 'header', this)">Header</button>
                            <button class="role-btn active" style="min-width:70px;" onclick="setAttRole('${att.filename}', 'none', this)">None</button>
                        </div>
                    </td>
                `;
                body.appendChild(tr);
            });
            document.getElementById('attachmentModal').style.display = 'flex';
        }

        function setAttRole(filename, role, btn) {
            const row = btn.parentElement;
            row.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if (role === 'target') selectedTargetAtt = filename;
            if (role === 'header') selectedHeaderAtt = filename;
            if (role === 'none') {
                if (selectedTargetAtt === filename) selectedTargetAtt = null;
                if (selectedHeaderAtt === filename) selectedHeaderAtt = null;
            }
        }


        async function confirmForensicSelection() {
            if (!selectedTargetAtt) { alert("Please select a target file."); return; }
            closeModal('attachmentModal');
            runFinalAnalysis(null, null, {
                session_id: currentSessionId,
                analysis_mode: 'attachment',
                target_attachment: selectedTargetAtt,
                header_attachment: selectedHeaderAtt
            });
        }

        // Global Error Handler for UI Crashes
        window.onerror = function (msg, url, line, col, error) {
            showInternalError(`UI Crash: ${msg} (Line: ${line})`);
        };

        window.onunhandledrejection = function (event) {
            showInternalError(`Eel/Promise Error: ${event.reason}`);
        };

        async function runFinalAnalysis(filename, content, forensicOptions = null) {
            isAnalysisInProgress = true;
            updateProgress(30, "Parsing headers...", "step_parse");
            const options = forensicOptions || { analysis_mode: 'direct' };
            try {
                const data = await eel.analyze_email_eel(filename, content, options)();

                // If user reset UI during analysis, discard results
                if (!isAnalysisInProgress) {
                    console.log("Analysis cancelled by user reset.");
                    return;
                }

                if (data && data.error) {
                    showInternalError(data.error);
                    return;
                }
                updateProgress(60, "Analyzing content...", "step_nlp");
                renderReport(data);

                updateProgress(80, "Checking reputation...", "step_intel");
                updateProgress(90, "Sandbox detonation...", "step_sandbox");

                updateProgress(100, "Analysis complete.", "step_sandbox");
                setTimeout(() => { if (document.getElementById('fullAnalysisProgress')) document.getElementById('fullAnalysisProgress').style.display = 'none'; }, 3000);
            } catch (err) {
                showInternalError(`Analysis Failure: ${err.message || err}`);
            }
        }

        function showInternalError(msg) {
            isAnalysisInProgress = false;
            const pbPercent = document.getElementById('pbPercent');
            const pbStatus = document.getElementById('pbStatus');
            const pbFill = document.getElementById('pbFill');

            if (pbPercent) pbPercent.innerText = "CRASH";
            if (pbStatus) pbStatus.innerText = "ERROR: " + msg;
            if (pbFill) pbFill.style.background = "var(--danger)";

            // Hide main results to prevent partial rendering
            const resultsGrid = document.getElementById('mainResults');
            if (resultsGrid) resultsGrid.style.display = 'none';

            // Show dedicated crash section
            const crashSec = document.getElementById('crashErrorSection');
            const crashMsg = document.getElementById('crashErrorMessage');
            if (crashSec && crashMsg) {
                crashSec.style.display = 'block';
                crashMsg.innerText = msg;
            }
            console.error("DESAS Internal Error:", msg);
        }

        let currentAnalysisData = null;

        function renderReport(data) {
            try {
                isAnalysisInProgress = false;
                if (!data) throw new Error("Received empty data from analyzer");
                currentAnalysisData = data;
                document.getElementById('mainResults').style.display = 'grid';

                // Hide Welcome Card
                const welcome = document.getElementById('welcomeCard');
                if (welcome) welcome.style.display = 'none';

                // SHOW Report Content
                const reportContent = document.getElementById('reportContent');
                if (reportContent) reportContent.style.display = 'block';

                document.getElementById('emailMetadata').style.display = 'block';
                document.getElementById('egressedDomainsSection').style.display = 'block';

                // Sidebar
                const banner = document.getElementById('sidebarVerdictBox');
                banner.className = `verdict-banner ${data.verdict}`;
                document.getElementById('sidebarVerdictText').innerText = data.verdict;

                const threatBadge = document.getElementById('threatBadge');
                if (data.verdict !== 'Benign' && data.threat_category) {
                    threatBadge.style.display = 'inline-block';
                    threatBadge.innerText = data.threat_category;
                    threatBadge.style.background = data.verdict === 'Malicious' ? 'var(--danger)' : (data.verdict === 'Suspicious' ? 'var(--warning)' : 'var(--text-muted)');
                } else { threatBadge.style.display = 'none'; }

                // Metadata
                const setSafeTxt = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val || 'N/A'; };
                setSafeTxt('metaSubject', data.subject);
                setSafeTxt('metaSender', data.sender);
                setSafeTxt('metaRecipient', data.recipient);
                setSafeTxt('metaDate', data.date);
                if (document.getElementById('metaAttachments')) document.getElementById('metaAttachments').innerText = data.attachments?.length || 0;

                // Auth Icons
                const authDiv = document.getElementById('headerAuthIcons');
                if (authDiv) {
                    authDiv.innerHTML = '';
                    if (data.auth_results) {
                        const makeIcon = (label, status, details = "") => {
                            const s = (status || '').toLowerCase();
                            const isPass = s === 'pass';
                            const isFail = s.includes('fail');
                            const color = isPass ? 'var(--success)' : (isFail ? 'var(--danger)' : 'var(--text-muted)');
                            return `<div title="${details}" style="text-align:center; background:#f9fafb; padding:12px; border-radius:8px; border:1px solid var(--border); flex:1; min-width:80px; position:relative;">
                            <div style="font-size:1.25rem; font-weight:bold; color:${color};">${isPass ? '‚úì' : (isFail ? '‚ö†' : '?')}</div>
                            <div style="font-size:0.75rem; font-weight:700; color:var(--text-muted); margin-top:4px;">${label}</div>
                            <div style="font-size:0.6rem; color:${color}; font-weight:800;">${(status || 'NONE').toUpperCase()}</div>
                        </div>`;
                        };
                        authDiv.innerHTML += makeIcon('SPF', data.auth_results.spf?.status, data.auth_results.spf?.details);
                        authDiv.innerHTML += makeIcon('DKIM', data.auth_results.dkim?.status, data.auth_results.dkim?.details);
                        authDiv.innerHTML += makeIcon('DMARC', data.auth_results.dmarc?.status, data.auth_results.dmarc?.details);

                        if (data.auth_results.tls && data.auth_results.tls.version !== "Unknown") {
                            authDiv.innerHTML += `<div style="text-align:center; background:#eff6ff; padding:12px; border-radius:8px; border:1px solid #bfdbfe; flex:1; min-width:80px;">
                            <div style="font-size:1rem; font-weight:bold; color:var(--primary);">üîí</div>
                            <div style="font-size:0.7rem; font-weight:700; color:var(--text-muted); margin-top:4px;">TLS</div>
                            <div style="font-size:0.55rem; color:var(--primary); font-weight:800;">${data.auth_results.tls.version}</div>
                        </div>`;
                        }
                    }
                }

                // Technical Headers Population
                const techDiv = document.getElementById('technicalHeadersContent');
                if (techDiv && data.all_headers) {
                    techDiv.innerText = data.all_headers.map(h => `${h.name}: ${h.value}`).join('\n');
                }

                // Reputation
                const repBox = document.getElementById('senderReputationBox');
                if (repBox) {
                    const hops = data.hops || [];
                    const lastIp = hops.length ? hops[hops.length - 1].ip : 'Unknown';
                    const intel = data.ip_intel?.[lastIp];
                    if (intel) {
                        const score = intel.abuse_score !== undefined ? intel.abuse_score : (intel.reputation?.abuse_score || 0);
                        const color = score > 50 ? 'var(--danger)' : (score > 10 ? 'var(--warning)' : 'var(--success)');
                        repBox.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                            <span style="font-weight:700;">${lastIp}</span>
                            <span class="badge" style="background:${color}; color:white;">${score > 50 ? '‚ö†Ô∏è High Abuse' : '‚úì Good Rep'}</span>
                        </div>
                        <div style="font-size:0.8125rem; color:var(--text-muted);">
                            ISP: ${intel.isp || 'N/A'}<br>Country: ${intel.geo?.country || 'N/A'}
                        </div>
                    `;
                    } else { repBox.innerHTML = "No reputation data for source IP."; }
                }

                // Hops
                const hopsTable = document.getElementById('headerHopsTableBody');
                if (hopsTable) {
                    const hops = data.hops || [];
                    hopsTable.innerHTML = hops.length ? hops.map(h => `<tr><td>#${h.hop}</td><td>${h.delay}</td><td>${h.from}<br><small>${h.ip}</small></td><td>-</td><td>${h.time}</td></tr>`).join('') : "<tr><td colspan='5'>No hops detected</td></tr>";
                }

                // NLP Results Mapping
                const nlpList = document.getElementById('nlpInsightsList');
                if (nlpList) {
                    const nlpReasons = data.body_reasons || [];
                    nlpList.innerHTML = nlpReasons.length ?
                        nlpReasons.map(r => `<div class="indicator-item" style="margin-bottom:8px; padding:8px;">üéØ ${r}</div>`).join('') :
                        "No suspicious patterns identified.";
                }

                // Intelligence Table Population
                const intelTableBody = document.getElementById('intelTableBody');
                if (intelTableBody) {
                    const domains = data.suspicious_domains || [];
                    const whitelistedSnapshot = data.whitelisted_domains || [];
                    const urls = data.extracted_urls || [];

                    // Fetch current global whitelist from memory or backend if needed
                    // For the most "live" feel, we assume window.globalWhitelist is kept in sync
                    const liveWhitelist = window.globalWhitelist || whitelistedSnapshot;

                    const sidebarDomainsList = document.getElementById('egressedDomainsList');

                    const extractHostname = (url) => {
                        try {
                            if (!url) return "";
                            if (!url.includes('://')) url = 'http://' + url;
                            const u = new URL(url);
                            return u.hostname.toLowerCase();
                        } catch (e) {
                            const match = url.match(/^(?:https?:\/\/)?(?:[^@\n]+@)?(?:www\.)?([^:\/\n?]+)/im);
                            return match ? match[1].toLowerCase() : url.toLowerCase();
                        }
                    };

                    const allDomainsRaw = [
                        ...(data.suspicious_domains || []),
                        ...(data.whitelisted_domains || []),
                        ...(data.extracted_urls || []).map(u => extractHostname(u))
                    ].filter(d => d && d.includes('.') && d.length > 3);

                    const allDomains = [...new Set(allDomainsRaw)].sort();

                    if (allDomains.length > 0) {
                        sidebarDomainsList.innerHTML = allDomains.map(d => `
                            <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:#f8fafc; border:1px solid var(--border); border-radius:8px; margin-bottom:8px;">
                                <span style="word-break:break-all; padding-right:8px; font-weight:600;">${d}</span>
                                ${liveWhitelist.includes(d) ?
                                `<span style="color:var(--success); font-weight:800; font-size:0.6rem;">SAFE</span>` :
                                `<button class="btn" style="width:auto; padding:2px 6px; font-size:0.55rem; background:var(--primary); color:white; border-radius:4px;" onclick="addToWhitelist('${d}', this)">+ White</button>`
                            }
                            </div>
                        `).join('');
                    } else {
                        sidebarDomainsList.innerHTML = '<div style="font-size:0.75rem; color:var(--text-muted); opacity:0.6;">No external domains found.</div>';
                    }

                    // Malicious Summary
                    const maliciousSummary = document.getElementById('maliciousSummary');
                    const maliciousHitsList = document.getElementById('maliciousHitsList');
                    const maliciousArtifacts = [];

                    let intelHtml = '';
                    const allArtifacts = [
                        ...domains.map(d => ({ type: 'Domain', val: d })),
                        ...urls.map(u => ({ type: 'URL', val: u })),
                        ...whitelistedSnapshot.map(w => ({ type: 'Whitelisted', val: w })) // Use snapshot for this table
                    ];

                    if (allArtifacts.length === 0) {
                        intelHtml = `<tr><td colspan="4" style="text-align:center; padding:32px; color:var(--text-muted);">No artifacts identified for analysis.</td></tr>`;
                        maliciousSummary.style.display = 'none';
                    } else {
                        intelHtml = allArtifacts.map(art => {
                            const intel = data.url_intel?.[art.val];
                            const hits = intel?.hits || 0;
                            if (hits > 0) maliciousArtifacts.push({ val: art.val, hits });

                            const isWhitelisted = liveWhitelist.includes(art.val); // Use live whitelist here
                            const color = hits > 0 ? 'var(--danger)' : (isWhitelisted ? 'var(--success)' : '#64748b');
                            const bgColor = hits > 0 ? '#fee2e2' : (isWhitelisted ? '#f0fdf4' : 'transparent');

                            const age = intel?.age !== undefined ? `${intel.age}d` : '-';
                            const registrar = intel?.registrar || '-';
                            const categories = (intel?.categories || []).slice(0, 3).join(', ') || '-';
                            const tags = (intel?.tags || []).slice(0, 3).join(', ') || '-';
                            const indicator = isWhitelisted ? '‚úÖ' : (hits > 0 ? 'üö®' : 'üõ°Ô∏è');

                            return `
                                <tr style="background:${bgColor};">
                                    <td style="font-size:0.65rem; font-weight:800; color:var(--text-muted);">${art.type.toUpperCase()}</td>
                                    <td style="word-break:break-all; font-weight:600; font-size:0.75rem;">
                                        ${indicator} <a href="#" onclick="openVT('${art.val}')" style="color:var(--primary); text-decoration:none;">${art.val}</a>
                                    </td>
                                    <td style="color:${color}; font-weight:800; font-size:1rem;">${hits}</td>
                                    <td>${registrar}<br><small>${age}</small></td>
                                    <td style="font-size:0.65rem; line-height:1.2;">
                                        <strong>CAT:</strong> ${categories}<br>
                                        <strong>TAGS:</strong> ${tags}
                                    </td>
                                </tr>
                            `;
                        }).join('');

                        if (maliciousArtifacts.length > 0) {
                            maliciousSummary.style.display = 'block';
                            maliciousHitsList.innerHTML = maliciousArtifacts.map(m => `‚Ä¢ <strong>${m.val}</strong> (${m.hits} VT hits)`).join('<br>');
                        } else {
                            maliciousSummary.style.display = 'none';
                        }
                    }
                    intelTableBody.innerHTML = intelHtml;


                    // HTML Forensics (Infrastructure)
                    const jsList = document.getElementById('jsIndicatorList');
                    if (jsList) jsList.innerHTML = (data.html_analysis?.js_indicators || []).map(i => `<div style="color:var(--danger); font-size:0.75rem; margin-bottom:4px;">‚ö†Ô∏è ${i}</div>`).join('') || "No JS flags.";
                    const formsList = document.getElementById('detectedFormsList');
                    if (formsList) formsList.innerHTML = (data.html_analysis?.forms || []).map(f => `<div style="font-size:0.75rem; margin-top:4px;">üìù <strong>${f.method} form</strong> to <span style="color:var(--primary);">${f.action}</span></div>`).join('') || "No forms detected.";

                    // Enhanced File Analysis (Excel Macros / PDF IOCs)
                    const attList = document.getElementById('attachmentsList');
                    if (attList) {
                        attList.innerHTML = (data.attachments || []).map(a => {
                            const forensics = a.forensics || {};
                            let detailsHtml = '';

                            // Excel/Office Details
                            if (forensics.has_macros) detailsHtml += `<div style="color:var(--danger); font-size:0.7rem;">‚ö†Ô∏è Macros Detected</div>`;
                            if (forensics.ole_macros && forensics.ole_macros.length > 0) {
                                detailsHtml += `<div style="font-size:0.65rem; color:var(--text-muted); margin-left:8px;">${forensics.ole_macros.length} macro streams found</div>`;
                            }

                            // PDF/Link Details
                            if (a.nested_intel && Object.keys(a.nested_intel).length > 0) {
                                const count = Object.keys(a.nested_intel).length;
                                const malCount = Object.values(a.nested_intel).filter(i => i.score > 0).length;
                                detailsHtml += `<div style="font-size:0.7rem; margin-top:4px;">üîó ${count} Links extracted (${malCount} <span style="color:${malCount > 0 ? 'var(--danger)' : 'var(--success)'}">suspicious</span>)</div>`;
                            }

                            // General flags
                            if (forensics.high_entropy) detailsHtml += `<div style="color:var(--warning); font-size:0.7rem;">‚ö†Ô∏è High Entropy (Packed?)</div>`;
                            if (forensics.polyglot) detailsHtml += `<div style="color:var(--danger); font-size:0.7rem;">‚ö†Ô∏è Polyglot File Detected</div>`;

                            return `
                        <div class="indicator-item" style="display:flex; flex-direction:column; gap:4px;">
                            <div style="display:flex; justify-content:space-between;">
                                <div><strong>${a.filename}</strong><br><small>${a.md5}</small></div>
                                <span class="badge" style="background:${a.risk === 'Clean' ? 'var(--success)' : 'var(--danger)'}; color:white; height:fit-content;">${a.risk}</span>
                            </div>
                            ${detailsHtml ? `<div style="background:white; padding:8px; border-radius:6px; margin-top:4px; border:1px solid var(--border);">${detailsHtml}</div>` : ''}
                        </div>
                    `;
                        }).join('') || "No attachments.";
                    }
                }

                // Sandbox
                const sandboxGrid = document.getElementById('sandboxResultsGrid');
                sandboxGrid.innerHTML = '';
                const sbUrls = data.extracted_urls || [];

                // Re-create noSandboxMsg if it was cleared
                let noSandboxMsg = document.getElementById('noSandboxMsg');
                if (!noSandboxMsg) {
                    noSandboxMsg = document.createElement('div');
                    noSandboxMsg.id = 'noSandboxMsg';
                    noSandboxMsg.style = "grid-column: 1 / -1; padding: 64px; text-align: center; background: white; border-radius: 12px; border: 1px dashed var(--border); color: var(--text-muted);";
                    noSandboxMsg.innerHTML = '<div style="font-size:2rem; margin-bottom:12px;">üî¨</div><div>Awaiting URL extraction for sandbox detonation.</div>';
                    sandboxGrid.appendChild(noSandboxMsg);
                }

                if (sbUrls.length) {
                    noSandboxMsg.style.display = 'none';
                    sbUrls.slice(0, 5).forEach(async (url, idx) => {
                        const card = document.createElement('div');
                        card.className = 'card';
                        card.innerHTML = `<div >üîç Queuing Sandbox for ${url}...</div> `;
                        sandboxGrid.appendChild(card);

                        try {
                            const sbData = await eel.analyze_standalone_eel('url', url)();
                            if (sbData && sbData.error) {
                                card.innerHTML = `
                                    <div style="color:var(--danger); padding:12px; border:1px dashed var(--danger); border-radius:8px;">
                                        <strong>‚ùå Error detonating URL:</strong><br>
                                        <small style="word-break:break-all;">${url}</small><br>
                                        <div style="margin-top:8px; font-size:0.75rem;">Reason: ${sbData.error}</div>
                                    </div>
                                `;
                            } else if (sbData) {
                                renderSandboxCard(card, sbData, url);
                            } else {
                                card.innerHTML = `<div style="color:var(--danger);">No response from sandbox for ${url}</div>`;
                            }
                        } catch (e) {
                            console.error(`Sandbox failure for ${url}:`, e);
                            card.innerHTML = `<div style="color:var(--danger); padding:12px;"><strong>Error:</strong> Failed to reach sandbox.</div>`;
                        }
                    });
                } else {
                    noSandboxMsg.style.display = 'block';
                }
            } catch (err) {
                showInternalError(`Rendering Error: ${err.message}`);
            }
        }

        async function addToWhitelist(domain, btn) {
            if (btn) {
                btn.innerText = "Adding...";
                btn.disabled = true;
            }

            try {
                // Extract domain if it's a URL
                try {
                    if (domain.includes('://')) {
                        domain = new URL(domain).hostname;
                    }
                } catch (e) { }

                const result = await eel.add_domain_to_whitelist(domain)();
                if (result.status === 'success') {
                    if (btn) {
                        btn.innerText = "Added";
                        btn.style.background = "var(--success)";
                    }
                    showToast(`‚úÖ Added ${domain} to whitelist`);

                    // Refresh global whitelist and re-render report
                    await loadWhitelistInModal();
                } else {
                    if (btn) {
                        btn.innerText = "+ White";
                        btn.disabled = false;
                    }
                    showToast("‚ùå Error: " + result.message);
                }
            } catch (err) {
                if (btn) {
                    btn.innerText = "+ White";
                    btn.disabled = false;
                }
                showToast("‚ùå Connection error");
            }
        }

        async function removeFromWhitelist(domain) {
            const result = await eel.remove_domain_from_whitelist(domain)();
            if (result.status === 'success') {
                showToast(`‚ÑπÔ∏è Removed ${domain} from whitelist`);
                // Refresh global whitelist and re-render report
                await loadWhitelistInModal();
            }
        }

        function generateReport() {
            if (!currentAnalysisData) {
                showToast("‚ùå No analysis data available to export.");
                return;
            }
            document.getElementById('exportModal').style.display = 'flex';
        }

        async function exportReport(format) {
            closeModal('exportModal');

            if (format === 'pdf') {
                const result = await eel.download_forensic_report(currentAnalysisData)();
                if (result.status === 'success') {
                    const win = window.open("", "_blank");
                    if (!win) {
                        showToast("‚ùå Pop-up blocked! Please allow pop-ups to view PDF.");
                        return;
                    }
                    try {
                        win.document.write(atob(result.content));
                        win.document.close();
                        setTimeout(() => {
                            if (win) win.print();
                        }, 500);
                    } catch (e) {
                        console.error("PDF Window error:", e);
                        showToast("‚ùå Error: Could not render PDF window.");
                    }
                }
                return;
            }

            if (format === 'html') {
                const btn = document.getElementById('downloadReportBtn');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = 'Generating...';
                btn.disabled = true;

                try {
                    const result = await eel.download_forensic_report(currentAnalysisData)();
                    if (result.status === 'success') {
                        const filename = `DESAS_Report_${currentAnalysisData.subject.replace(/[^a-z0-9]/gi, '_')}.html`;
                        downloadBase64File(result.content, filename, 'text/html');
                        showToast("‚úÖ HTML Report downloaded.");
                    } else {
                        showToast("‚ùå Error: " + result.message);
                    }
                } catch (e) {
                    showToast("‚ùå Error: " + e);
                } finally {
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }
                return;
            }

            if (format === 'both') {
                showToast("üì¶ Bundling ZIP case archive...");
                try {
                    const result = await eel.bundle_forensic_case(currentAnalysisData)();
                    if (result.status === 'success') {
                        downloadBase64File(result.content, result.filename, 'application/zip');
                        showToast("‚úÖ Case ZIP Bundle downloaded.");
                    } else {
                        showToast("‚ùå Error: " + result.message);
                    }
                } catch (e) {
                    showToast("‚ùå Error: " + e);
                }
            }
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function downloadBase64File(base64Content, fileName, mimeType) {
            const linkSource = `data:${mimeType};base64,${base64Content}`;
            const downloadLink = document.createElement("a");
            downloadLink.href = linkSource;
            downloadLink.download = fileName;
            downloadLink.click();
        }

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.style = "position:fixed; bottom:20px; right:20px; background:var(--primary); color:white; padding:12px 24px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:10000; animation:slideIn 0.3s ease-out;";
            toast.innerHTML = msg;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = "slideOut 0.3s ease-in";
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function openVT(artifact) {
            // If it's a domain/URL, we can construct the VT URL
            let vtUrl = `https://www.virustotal.com/gui/search/${encodeURIComponent(artifact)}`;
            await eel.open_external_url(vtUrl)();
        }

        function renderSandboxCard(el, sb, url) {
            const scoreColor = sb.score > 70 ? 'var(--danger)' : (sb.score > 30 ? 'var(--warning)' : 'var(--success)');
            el.innerHTML = `
                <div class="section-header">
                    <h2><span>üî¨</span> Sandbox Result</h2>
                    <span class="badge" style="background:${scoreColor}; color:white;">Result: ${sb.score > 70 ? 'Malicious' : (sb.score > 30 ? 'Suspicious' : 'Clean')}</span>
                </div>
                <div style="font-family:monospace; font-size:0.8rem; margin-bottom:12px; word-break:break-all;">${url}</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
                    <ul>${sb.reasons.map(r => `<li>‚ö†Ô∏è ${r}</li>`).join('') || "No flags."}</ul>
                    ${sb.screenshot_path ? `<img src="/${sb.screenshot_path}" style="width:100%; border-radius:8px; border:1px solid var(--border);">` : "No screenshot."}
                </div>
            `;
        }

        async function analyzeToolkit(type) {
            const content = document.getElementById('toolkitResultsContent');
            const resultsSection = document.getElementById('toolkitResults');
            resultsSection.style.display = 'block';
            content.innerHTML = '<div class="loader"></div>';

            let input;
            if (type === 'header') input = document.getElementById('standaloneHeaderInput').value;
            if (type === 'url') input = document.getElementById('standaloneUrlInput').value;
            if (type === 'domain') input = document.getElementById('standaloneDomainInput').value;
            if (type === 'ip') input = document.getElementById('standaloneIpInput').value;

            if (type === 'attachment') {
                const fileInput = document.getElementById('toolkitFileInput');
                const file = fileInput.files[0];
                if (!file) {
                    content.innerHTML = '<div style="color:var(--danger);">Please select a file first.</div>';
                    return;
                }
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64 = e.target.result.split(',')[1];
                    try {
                        const res = await eel.analyze_standalone_eel('attachment', { filename: file.name, content: base64 })();
                        renderToolkitResults('attachment', res, content);
                    } catch (err) { content.innerHTML = `<div style="color:var(--danger);">Error: ${err}</div>`; }
                };
                reader.readAsDataURL(file);
                return;
            }

            try {
                const res = await eel.analyze_standalone_eel(type, input)();
                renderToolkitResults(type, res, content);
            } catch (e) { content.innerHTML = `<div style="color:var(--danger);">Error: ${e}</div>`; }
        }

        function renderToolkitResults(type, data, el) {
            if (data.error) {
                el.innerHTML = `<div style="color:var(--danger); padding:16px;"><strong>Error:</strong> ${data.error}</div>`;
                return;
            }

            if (type === 'attachment') {
                const att = data.attachment || {};
                const forensics = att.forensics || {};
                const scoreColor = data.score > 70 ? 'var(--danger)' : (data.score > 30 ? 'var(--warning)' : 'var(--success)');

                let html = `
                    <div style="border:none; box-shadow:none; padding:0;">
                        <div class="section-header" style="margin-bottom:16px;">
                            <h2 style="font-size:1.1rem;">üìä Static Forensic Report</h2>
                            <span class="badge" style="background:${scoreColor}; color:white;">Risk: ${att.risk || 'Unknown'}</span>
                        </div>
                        
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                            <div style="background:#f8fafc; padding:12px; border-radius:8px; border:1px solid var(--border);">
                                <h4 style="font-size:0.65rem; text-transform:uppercase; color:var(--text-muted); margin-bottom:8px;">File Metadata</h4>
                                <div style="font-size:0.75rem; margin-bottom:4px; max-width:250px; overflow:hidden; text-overflow:ellipsis;"><strong>Name:</strong> ${att.filename}</div>
                                <div style="font-size:0.7rem; font-family:monospace; word-break:break-all;"><strong>MD5:</strong> ${att.md5}</div>
                                <div style="font-size:0.7rem; font-family:monospace; word-break:break-all; margin-top:4px;"><strong>SHA256:</strong> ${att.sha256}</div>
                                <div style="font-size:0.75rem; margin-top:8px;"><strong>VT Scans:</strong> ${att.vt_stats || 'N/A'}</div>
                            </div>
                            <div style="background:#f8fafc; padding:12px; border-radius:8px; border:1px solid var(--border);">
                                <h4 style="font-size:0.65rem; text-transform:uppercase; color:var(--text-muted); margin-bottom:8px;">Forensic Signals</h4>
                                <div style="display:flex; flex-wrap:wrap; gap:8px;">
                                    <span class="badge" style="background:${forensics.has_macros ? 'var(--danger)' : '#e2e8f0'}; color:${forensics.has_macros ? 'white' : 'var(--text-muted)'}; font-size:0.6rem;">MACROS: ${forensics.has_macros ? 'YES' : 'NO'}</span>
                                    <span class="badge" style="background:${forensics.high_entropy ? 'var(--warning)' : '#e2e8f0'}; color:${forensics.high_entropy ? 'white' : 'var(--text-muted)'}; font-size:0.6rem;">ENTROPY: ${forensics.high_entropy ? 'HIGH' : 'LOW'}</span>
                                    <span class="badge" style="background:${forensics.polyglot ? 'var(--danger)' : '#e2e8f0'}; color:${forensics.polyglot ? 'white' : 'var(--text-muted)'}; font-size:0.6rem;">POLYGLOT: ${forensics.polyglot ? 'YES' : 'NO'}</span>
                                    <span class="badge" style="background:${forensics.obfuscation ? 'var(--warning)' : '#e2e8f0'}; color:${forensics.obfuscation ? 'white' : 'var(--text-muted)'}; font-size:0.6rem;">OBFUSCATION: ${forensics.obfuscation ? 'YES' : 'NO'}</span>
                                </div>
                                <div style="margin-top:12px; font-size:0.75rem;">
                                    <strong>Detected Techniques:</strong><br>
                                    ${(forensics.mitre_techniques || []).map(t => `<span style="color:var(--primary); font-family:monospace;">${t}</span>`).join(', ') || 'None'}
                                </div>
                            </div>
                        </div>

                        <div style="margin-top:20px;">
                            <h3 style="font-size:0.75rem; text-transform:uppercase; color:var(--text-muted); margin-bottom:12px; border-bottom:1px solid var(--border); padding-bottom:4px;">Interrogated Intelligence (Nested Links) üõ°Ô∏è</h3>
                            <div class="table-container">
                                <table style="font-size:0.75rem;">
                                    <thead><tr><th>ARTIFACT</th><th>REPUTATION (VT)</th><th>CONTEXT</th><th>ACTION</th></tr></thead>
                                    <tbody>
                                        ${Object.entries(att.nested_intel || {}).map(([url, intel]) => `
                                            <tr>
                                                <td style="word-break:break-all; max-width:300px;">${url}</td>
                                                <td style="color:${intel.score > 0 ? 'var(--danger)' : 'var(--success)'}; font-weight:800;">${intel.intel?.hits || 0} HITS</td>
                                                <td>${intel.reason || (intel.age ? `Domain: ${intel.age}d` : 'Clean')}</td>
                                                <td><button class="btn" style="padding:4px 8px; font-size:0.65rem;" onclick="document.getElementById('standaloneUrlInput').value='${url}'; analyzeToolkit('url')">Detonate</button></td>
                                            </tr>
                                        `).join('') || '<tr><td colspan="4" style="text-align:center; padding:12px; opacity:0.6;">No nested links found.</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        ${att.extracted_text ? `
                            <div style="margin-top:20px;">
                                <h3 style="font-size:0.75rem; text-transform:uppercase; color:var(--text-muted); margin-bottom:12px;">Extracted Content Preview</h3>
                                <pre style="background:#f1f5f9; padding:12px; border-radius:8px; font-size:0.7rem; max-height:200px; overflow-y:auto; white-space:pre-wrap; font-family:monospace;">${att.extracted_text}</pre>
                            </div>
                        ` : ''}
                    </div>
                `;
                el.innerHTML = html;
            } else if (type === 'domain') {
                el.innerHTML = `
                    <div style="padding:16px; background:#f8fafc; border-radius:8px; border:1px solid var(--border);">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                            <h3>Domain Intelligence: ${data.domain}</h3>
                            <span class="badge" style="background:${data.score > 0 ? 'var(--danger)' : 'var(--success)'}; color:white;">Result: ${data.score > 0 ? 'Suspicious' : 'Clean'}</span>
                        </div>
                        <div style="font-size:0.85rem;">
                            <strong>Reason:</strong> ${data.reason || 'Clean'}<br>
                            <strong>Age:</strong> ${data.age_days !== null ? data.age_days + ' days' : 'Unknown'}<br>
                            <strong>Registrar:</strong> ${data.intel?.registrar || 'Unknown'}
                        </div>
                    </div>
                `;
            } else {
                el.innerHTML = `<pre style="font-size:0.75rem; white-space:pre-wrap; background:#f8fafc; padding:16px; border-radius:8px;">${JSON.stringify(data, null, 2)}</pre>`;
            }
        }

        function toggleTechnicalHeaders() {
            const el = document.getElementById('technicalHeadersContent');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        function cancelAnalysis() {
            if (confirm("Are you sure you want to cancel the current analysis?")) {
                location.reload(); // Simplest way to abort all pending promises/states
            }
        }

        function updateProgress(percent, status, stepId = null) {
            const pb = document.getElementById('fullAnalysisProgress');
            const cancelBtn = document.getElementById('cancelAnalysisBtn');
            const pbFill = document.getElementById('pbFill');
            const pbPercent = document.getElementById('pbPercent');

            pb.style.display = 'block';
            if (cancelBtn) cancelBtn.style.display = (percent > 0 && percent < 100) ? 'block' : 'none';

            // Smoothly animate width
            // requestAnimationFrame to ensure UI updates
            requestAnimationFrame(() => {
                pbFill.style.width = percent + '%';
            });

            document.getElementById('pbStatus').innerText = status;
            pbPercent.innerText = percent + '%';

            if (stepId) {
                const steps = document.querySelectorAll('.step-item');
                let foundActive = false;
                steps.forEach(s => {
                    if (s.id === stepId) {
                        s.className = 'step-item active';
                        // Add a pulsing effect or similar if desired via CSS
                        foundActive = true;
                    } else {
                        if (!foundActive) {
                            s.className = 'step-item done';
                        } else {
                            s.className = 'step-item';
                        }
                    }
                });

                // If complete, mark all as done
                if (percent >= 100) {
                    steps.forEach(s => s.className = 'step-item done');
                }
            }
        }

        // Drag & Drop
        const dz = document.getElementById('drop-zone');
        window.addEventListener('dragenter', e => { e.preventDefault(); dz.classList.add('active'); });
        dz.addEventListener('dragleave', e => { e.preventDefault(); dz.classList.remove('active'); });
        window.addEventListener('dragover', e => e.preventDefault());
        window.addEventListener('drop', e => {
            e.preventDefault();
            dz.classList.remove('active');
            if (e.dataTransfer.files.length) {
                document.getElementById('fileInput').files = e.dataTransfer.files;
                handleFile();
            }
        });

        window.onload = async () => {
            console.log('DESAS initialized üöÄ');
            try {
                const settings = await eel.get_app_settings()();
                if (!settings || (!settings.VIRUSTOTAL_API_KEY && !settings.ABUSEIPDB_API_KEY)) {
                    document.getElementById('apiCheckModal').style.display = 'flex';
                }
                // Pre-load global whitelist for real-time marking
                await loadWhitelistInModal();
            } catch (e) {
                console.error("Failed to check API keys startup:", e);
            }
        };

        // SETTINGS & WHITELIST LOGIC
        async function openSettingsModal() {
            document.getElementById('settingsModal').style.display = 'flex';
            await loadSettingsInModal();
            await loadWhitelistInModal();
        }

        async function loadSettingsInModal() {
            try {
                const settings = await eel.get_app_settings()();
                if (settings) {
                    document.getElementById('vt_key').value = settings.VIRUSTOTAL_API_KEY || '';
                    document.getElementById('mxtoolbox_key').value = settings.MXTOOLBOX_API_KEY || '';
                    document.getElementById('abuse_key').value = settings.ABUSEIPDB_API_KEY || '';
                }
            } catch (e) { console.error("Failed to load settings:", e); }
        }

        async function loadWhitelistInModal() {
            try {
                const list = await eel.get_domain_whitelist()();
                window.globalWhitelist = list || [];
                renderWhitelistModal(window.globalWhitelist);
                // Also trigger a re-render of current report to sync "SAFE" marks
                if (currentAnalysisData) {
                    renderReport(currentAnalysisData);
                }
            } catch (e) { console.error("Failed to load whitelist:", e); }
        }

        function renderWhitelistModal(list) {
            const container = document.getElementById('whitelistModalTableBody');
            if (container) {
                if (list.length === 0) {
                    container.innerHTML = '<tr><td style="text-align:center; padding:24px; color:var(--text-muted);">No domains found.</td></tr>';
                    return;
                }
                container.innerHTML = list.map(item => `
                    <div class="whitelist-item-row">
                        <div style="font-weight: 600; padding: 8px 12px; flex: 1;">${item}</div>
                        <div style="padding: 8px;">
                            <button class="btn" style="width: 32px; height: 32px; padding: 0; font-size: 0.9rem; color: var(--danger); border: 1px solid #fecaca; background: #fee2e2; border-radius: 8px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s;"
                                onclick="removeDomainModal('${item}')">‚úï</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function filterWhitelistModal(query) {
            const filtered = (window.globalWhitelist || []).filter(d => d.toLowerCase().includes(query.toLowerCase()));
            renderWhitelistModal(filtered);
        }

        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('saveSettingsBtn');
            const status = document.getElementById('settingsSaveStatus');
            btn.disabled = true;
            btn.innerText = 'Saving...';

            const payload = {
                VIRUSTOTAL_API_KEY: document.getElementById('vt_key').value,
                MXTOOLBOX_API_KEY: document.getElementById('mxtoolbox_key').value,
                ABUSEIPDB_API_KEY: document.getElementById('abuse_key').value
            };

            const res = await eel.update_app_settings(payload)();
            status.style.display = 'block';
            if (res.status === 'success') {
                status.innerText = '‚úÖ Saved successfully!';
                status.style.color = 'var(--success)';
            } else {
                status.innerText = '‚ùå Error: ' + res.message;
                status.style.color = 'var(--danger)';
            }
            btn.disabled = false;
            btn.innerText = 'Save Keys';
            setTimeout(() => { status.style.display = 'none'; }, 2000);
        });

        async function addDomainManual() {
            const domain = document.getElementById('newWhitelistDomain').value.trim();
            if (domain) {
                await eel.add_domain_to_whitelist(domain)();
                document.getElementById('newWhitelistDomain').value = '';
                await loadWhitelistInModal();
            }
        }

        async function removeDomainModal(domain) {
            await eel.remove_domain_from_whitelist(domain)();
            await loadWhitelistInModal();
        }

        function useDefaultSettings() {
            document.getElementById('vt_key').value = '';
            document.getElementById('mxtoolbox_key').value = '';
            document.getElementById('abuse_key').value = '';
            showToast('API fields cleared. Save to apply.');
        }

        async function exportWhitelist() {
            try {
                const res = await eel.export_whitelist_xl()();
                if (res.status === 'success') {
                    const link = document.createElement("a");
                    link.href = `data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,${res.content}`;
                    link.download = res.filename || 'whitelist.xlsx';
                    link.click();
                    showToast('‚úÖ Whitelist exported');
                } else { showToast('‚ùå Export failed'); }
            } catch (e) { showToast('Error: ' + e); }
        }

        async function importWhitelist(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            if (file.name.toLowerCase().endsWith('.xlsx')) {
                reader.onload = async (e) => {
                    const content = e.target.result.split(',')[1];
                    const res = await eel.import_whitelist_xl(content)();
                    if (res.status === 'success') { await loadWhitelistInModal(); showToast('‚úÖ Whitelist imported'); }
                };
                reader.readAsDataURL(file);
            } else {
                reader.onload = async (e) => {
                    const lines = e.target.result.split('\n').map(d => d.trim()).filter(d => d && !d.startsWith('#'));
                    for (const d of lines) await eel.add_domain_to_whitelist(d)();
                    await loadWhitelistInModal();
                    showToast(`‚úÖ Imported ${lines.length} domains`);
                };
                reader.readAsText(file);
            }
            input.value = '';
        }

        // Drop zone for API keys in modal
        const modalApiDrop = document.getElementById('apiDropZone');
        modalApiDrop.onclick = () => document.getElementById('apiFileInput').click();
        modalApiDrop.ondragover = (e) => { e.preventDefault(); modalApiDrop.classList.add('dragover'); };
        modalApiDrop.ondragleave = () => { modalApiDrop.classList.remove('dragover'); };
        modalApiDrop.ondrop = (e) => {
            e.preventDefault();
            modalApiDrop.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleModalApiFile(file);
        };

        function handleModalApiFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const lines = text.split('\n');
                let found = 0;
                lines.forEach(line => {
                    if (!line.includes('=')) return;
                    const parts = line.split('=');
                    const key = parts[0].trim().toUpperCase();
                    const val = parts[1].trim();
                    if (key.includes('VIRUSTOTAL') || key.includes('VT_KEY')) document.getElementById('vt_key').value = val, found++;
                    else if (key.includes('MXTOOLBOX') || key.includes('MX_KEY')) document.getElementById('mxtoolbox_key').value = val, found++;
                    else if (key.includes('ABUSE') || key.includes('ABUSEIPDB')) document.getElementById('abuse_key').value = val, found++;
                });
                if (found > 0) showToast(`‚úÖ Imported ${found} keys`);
            };
            reader.readAsText(file);
        }
    </script>
</body>

</html>