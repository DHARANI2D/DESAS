<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DESAS</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --danger: #dc2626;
            --warning: #f59e0b;
            --success: #10b981;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        .navbar {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar h1 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 800;
            letter-spacing: -0.025em;
            color: var(--primary);
        }

        .container {
            width: 100%;
            max-width: 100%;
            margin: 24px 0;
            padding: 0 40px;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 24px;
            box-sizing: border-box;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .sidebar-sticky {
            position: sticky;
            top: 80px;
        }

        .verdict-banner {
            text-align: center;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            transition: all 0.3s ease;
        }

        .verdict-banner.Malicious {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .verdict-banner.Suspicious {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .verdict-banner.Benign {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .verdict-banner.Pending {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #e5e7eb;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-bg);
            margin: 10% auto;
            padding: 32px;
            border-radius: 12px;
            max-width: 500px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 8px;
        }

        .form-group input[type="text"],
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.875rem;
            box-sizing: border-box;
        }

        .score-val {
            font-size: 3.5rem;
            font-weight: 900;
            margin: 8px 0;
        }

        .verdict-label {
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            width: 100%;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-main);
            margin-top: 12px;
        }

        .btn-outline:hover {
            background: #f9fafb;
        }

        h2 {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0 0 16px 0;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .module-grid {
            display: grid;
            gap: 24px;
        }

        .indicator-item {
            padding: 12px;
            border-radius: 8px;
            background: #f9fafb;
            border: 1px solid var(--border);
            margin-bottom: 12px;
        }

        .risk-text {
            color: var(--danger);
            font-weight: 500;
        }

        .safe-text {
            color: var(--success);
            font-weight: 500;
        }

        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid #e5e7eb;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        /* Progress Bar Styles */
        .progress-container {
            margin-bottom: 24px;
            display: none;
        }

        .progress-bar-bg {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.4s ease;
        }

        .progress-text {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
        }

        /* Source Tags */
        .source-tag {
            font-size: 0.65rem;
            background: #f3f4f6;
            color: var(--text-muted);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid var(--border);
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .source-tag::before {
            content: "üì°";
            font-size: 0.6rem;
        }

        .category-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-weight: 700;
            margin: 32px 0 16px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .category-label::after {
            content: "";
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        /* Restored Utility Classes */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
            margin-top: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th {
            background: #f9fafb;
            padding: 10px;
            text-align: left;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.875rem;
        }

        .screenshot-container {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
            margin-top: 16px;
        }

        .screenshot-container img {
            width: 100%;
            display: block;
        }

        /* Toolkit Styles */
        .toolkit-container {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .tool-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .tool-card h3 {
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }

        .toolkit-nav {
            display: flex;
            gap: 12px;
            margin-right: auto;
            margin-left: 24px;
        }

        .toolkit-nav a {
            text-decoration: none;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.875rem;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .toolkit-nav a.active {
            color: var(--primary);
            background: #eff6ff;
        }

        .standalone-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.875rem;
            margin-bottom: 12px;
            resize: vertical;
        }

        /* Drag & Drop Visuals */
        #drop-zone {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 9999;
            pointer-events: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
            transition: all 0.2s ease;
        }

        #drop-zone.active {
            display: flex;
        }

        .drop-zone-content {
            border: 3px dashed rgba(255, 255, 255, 0.8);
            border-radius: 24px;
            padding: 48px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
        }

        .drop-area-box {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            color: var(--text-muted);
            background: #f9fafb;
            margin-bottom: 24px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .drop-area-box:hover {
            border-color: var(--primary);
            background: #eff6ff;
            color: var(--primary);
        }

        .drop-area-box.dragover {
            border-color: var(--primary);
            background: #eff6ff;
            transform: scale(1.02);
        }

        /* Toolkit Dashboard Grid - Fixed & Compact */
        .toolkit-dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            box-sizing: border-box;
        }

        @media (min-width: 1024px) {
            .toolkit-dashboard {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .toolkit-dashboard .tool-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: relative;
            background-clip: padding-box;
        }

        .toolkit-dashboard .tool-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .toolkit-dashboard .tool-card h3 {
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            font-size: 1rem;
            color: var(--primary);
            font-weight: 700;
        }

        .toolkit-dashboard .tool-card p {
            margin: 0;
            line-height: 1.5;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .toolkit-dashboard .standalone-input {
            width: 100%;
            padding: 10px;
            font-size: 0.875rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-sizing: border-box;
        }

        .toolkit-dashboard textarea.standalone-input {
            min-height: 100px;
            resize: none;
        }

        .toolkit-dashboard .btn {
            width: 100%;
            padding: 10px;
            font-size: 0.875rem;
            font-weight: 600;
            height: auto;
            cursor: pointer;
            margin-top: auto;
        }

        /* All cards span 1 by default now for compactness */
        .tool-card.span-2 {
            grid-column: span 2;
        }

        @media (min-width: 1024px) {
            .toolkit-dashboard {
                grid-template-columns: 1fr 1fr;
            }
        }

        .header-file-btn {
            background: #f8fafc;
            border: 1px solid var(--border);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            color: var(--text-muted);
            cursor: pointer;
        }

        .role-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-muted);
        }

        .role-btn:hover {
            color: var(--primary);
        }

        .role-btn.active {
            color: var(--primary) !important;
        }
    </style>
</head>

<body>
    <div id="drop-zone">
        <div class="drop-zone-content">
            <div style="font-size: 5rem; margin-bottom: 20px;">üìÇ</div>
            <div style="font-size: 1.5rem; font-weight: 800;">Drop Email File Here</div>
            <div style="font-size: 1rem; opacity: 0.8; margin-top: 8px;">Supports .eml and .msg formats</div>
        </div>
    </div>
    <nav class="navbar">
        <h1>DESAS</h1>
        <div class="toolkit-nav">
            <a href="#" id="navAnalysis" class="active" onclick="showSection('analysis')">Full Analysis</a>
            <a href="#" id="navToolkit" onclick="showSection('toolkit')">Forensic Toolkit</a>
        </div>
        <div style="display: flex; gap: 12px;">
            <button class="btn btn-outline" style="width: auto; margin: 0;" onclick="downloadReport()" id="downloadBtn"
                disabled>
                <span>üì•</span> Download Report
            </button>
            <a href="/settings" class="btn btn-outline" style="width: auto; margin: 0; text-decoration: none;">
                <span>‚öôÔ∏è</span> Settings & Whitelist
            </a>
        </div>
    </nav>

    <div class="container" id="analysisSection">
        <aside class="sidebar-sticky">
            <div class="card" style="padding: 0; overflow: hidden;">
                <div id="sidebarVerdictBox" class="verdict-banner Pending">
                    <div class="verdict-label">Analysis Score</div>
                    <div id="sidebarTotalScore" class="score-val">0</div>
                    <div id="sidebarVerdictText" class="verdict-label">Ready</div>
                    <div id="threatBadge" class="badge" style="margin-top: 12px; display: none;"></div>
                </div>

                <div style="padding: 24px;">
                    <!-- Progress Bar Moved to Sidebar -->
                    <div id="fullAnalysisProgress" class="progress-container" style="margin-bottom: 24px;">
                        <div class="progress-bar-bg">
                            <div id="pbFill" class="progress-bar-fill"></div>
                        </div>
                        <div class="progress-text">
                            <span id="pbStatus">Ready for Analysis...</span>
                            <span id="pbPercent">0%</span>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label
                            style="font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; display: block;">Analysis
                            Depth</label>
                        <div id="analysisModeSelector"
                            style="display: flex; background: #f1f5f9; border-radius: 8px; padding: 4px; gap: 4px;">
                            <button class="mode-btn active" onclick="setAnalysisMode('direct', this)"
                                style="flex:1; border:none; padding:8px; font-size:0.75rem; border-radius:6px; cursor:pointer; background:var(--card-bg); box-shadow:0 2px 4px rgba(0,0,0,0.05); font-weight:700; color:var(--primary); transition: all 0.2s;">
                                üìß Direct
                            </button>
                            <button class="mode-btn" onclick="setAnalysisMode('forensic', this)"
                                style="flex:1; border:none; padding:8px; font-size:0.75rem; border-radius:6px; cursor:pointer; background:transparent; font-weight:600; color:var(--text-muted); transition: all 0.2s;">
                                üîç Deep Forensic
                            </button>
                        </div>
                    </div>

                    <script>
                        let activeAnalysisMode = 'direct';
                        function setAnalysisMode(mode, btn) {
                            activeAnalysisMode = mode;
                            document.querySelectorAll('.mode-btn').forEach(b => {
                                b.classList.remove('active');
                                b.style.background = 'transparent';
                                b.style.boxShadow = 'none';
                                b.style.color = 'var(--text-muted)';
                                b.style.fontWeight = '600';
                            });
                            btn.classList.add('active');
                            btn.style.background = 'var(--card-bg)';
                            btn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';
                            btn.style.color = 'var(--primary)';
                            btn.style.fontWeight = '700';

                            // Optional: Update drop area text based on mode
                            const dropTxt = document.querySelector('#sidebarDropArea div:nth-child(3)');
                            if (mode === 'forensic') {
                                dropTxt.innerText = "Extract, Decode & Select Artifacts";
                            } else {
                                dropTxt.innerText = "or Drag & Drop email here";
                            }
                        }
                    </script>

                    <div class="drop-area-box" id="sidebarDropArea"
                        onclick="document.getElementById('fileInput').click()">
                        <div style="font-size: 2rem; margin-bottom: 8px;">üì•</div>
                        <div style="font-weight: 700; font-size: 0.875rem;">Click to upload</div>
                        <div style="font-size: 0.75rem; opacity: 0.7;">or Drag & Drop email here</div>
                    </div>

                    <input type="file" id="fileInput" accept=".eml,.msg" style="display: none;" onchange="handleFile()">

                    <div style="margin-top: 32px; border-top: 1px solid var(--border); padding-top: 24px;">
                        <h3
                            style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 12px;">
                            Email Metadata</h3>
                        <div style="font-size: 0.8125rem; margin-bottom: 8px;">
                            <strong>Subject:</strong> <span id="overlaySubject">Unknown</span>
                        </div>
                        <div style="font-size: 0.8125rem; margin-bottom: 8px;">
                            <strong>Timestamp:</strong> <span id="overlayTimestamp">Unknown</span>
                        </div>
                        <div style="font-size: 0.8125rem; margin-bottom: 8px;">
                            <strong>Sender:</strong> <span id="overlaySender">Unknown</span>
                        </div>
                        <div style="font-size: 0.8125rem;">
                            <strong>Attachments:</strong> <span id="overlayAttachments">0</span>
                        </div>
                    </div>

                    <div style="margin-top: 32px; border-top: 1px solid var(--border); padding-top: 24px;">
                        <h3
                            style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 12px;">
                            üõ°Ô∏è Block List</h3>
                        <ul id="blockActions" style="list-style: none; padding: 0; margin: 0;">
                            <li style="color: var(--text-muted); font-style: italic; font-size: 0.8125rem;">No
                                recommendations yet.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </aside>

        <main class="module-grid">
            <!-- Progress Bar Removed from here -->

            <!-- Verdict Justification (Phase 1 Enhancement) -->
            <section class="card" id="verdictJustificationCard"
                style="display: none; margin-bottom: 24px; border-left: 4px solid var(--primary);">
                <div class="section-header">
                    <h2><span>üß†</span> Verdict Justification</h2>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span id="confidenceBadge" class="badge"
                            style="background: var(--primary); color: white;">Confidence: --</span>
                    </div>
                </div>
                <div id="verdictExplanationText"
                    style="margin-bottom: 20px; line-height: 1.6; white-space: pre-line; font-size: 0.9375rem;"></div>

                <div id="riskFactorsContainer" style="display: none;">
                    <h3
                        style="font-size: 0.875rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 12px; margin-top: 24px;">
                        Risk Factor Breakdown</h3>
                    <div id="riskFactorsList"></div>
                </div>
            </section>

            <!-- Score Breakdown (Phase 7 Enhancement) -->
            <section class="card" id="scoreBreakdownCard" style="display: none; margin-bottom: 24px;">
                <div class="section-header">
                    <h2><span>üìä</span> Score Breakdown</h2>
                    <span id="totalScoreBadge" class="badge" style="background: var(--primary); color: white;">Total:
                        --</span>
                </div>
                <div id="scoreBreakdownContent"></div>
            </section>

            <!-- Category 1: Header Intelligence -->
            <div class="category-label">Header Intelligence</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                <section class="card" id="headerAuthCard">
                    <div class="section-header">
                        <h2><span>üîê</span> Authentication</h2>
                        <span class="source-tag">RFC Standards</span>
                    </div>
                    <div id="headerAuthIcons" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                </section>

                <section class="card" id="ipIntelCard">
                    <div class="section-header">
                        <h2><span>üõ°Ô∏è</span> Sender Reputation</h2>
                        <span class="source-tag">AbuseIPDB</span>
                    </div>
                    <div id="senderReputationBox"></div>
                </section>
            </div>

            <section class="card" style="margin-bottom: 24px;">
                <div class="section-header">
                    <h2><span>üó∫Ô∏è</span> Delivery Hops</h2>
                    <span class="source-tag">Hop Analysis</span>
                </div>
                <div class="table-container">
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Hop</th>
                                <th>Delay</th>
                                <th>Source / IP</th>
                                <th>Security</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="headerHopsTableBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- Category 2: Infrastructure Intelligence -->
            <div class="category-label">Infrastructure Intelligence</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                <section class="card" id="mxToolboxSection" style="display: none;">
                    <div class="section-header">
                        <h2><span>‚öôÔ∏è</span> Domain Health</h2>
                        <span class="source-tag">MxToolbox</span>
                    </div>
                    <div id="mxResults"></div>
                </section>

                <section class="card" id="vtRadarSection" style="display: none;">
                    <div class="section-header">
                        <h2><span>üéØ</span> VT Radar</h2>
                        <span class="source-tag">VirusTotal</span>
                    </div>
                    <div id="vtDetailedIntel"></div>
                </section>
            </div>

            <section class="card" id="suspiciousDomainsSection" style="display: none; margin-bottom: 24px;">
                <div class="section-header">
                    <h2><span>üö©</span> Suspicious Domains</h2>
                    <span class="source-tag">Whois / Age</span>
                </div>
                <ul id="suspiciousDomainsList" style="list-style: none; padding: 0;"></ul>
            </section>

            <!-- Category 3: Content & Code Forensics -->
            <div class="category-label">Content & Code Forensics</div>
            <section class="card" id="htmlForensicsSection" style="display: none; margin-bottom: 24px;">
                <div class="section-header">
                    <h2><span>üß¨</span> Static HTML/JS Forensics</h2>
                    <span class="source-tag">DESAS DeepScan</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 24px;">
                    <div>
                        <h4
                            style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 12px;">
                            JS Indicators</h4>
                        <div id="jsIndicatorList"></div>
                    </div>
                    <div>
                        <h4
                            style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 12px;">
                            Form Analysis</h4>
                        <div id="detectedFormsList" style="display: grid; grid-template-columns: 1fr; gap: 12px;"></div>
                    </div>
                </div>
            </section>

            <section class="card" style="margin-bottom: 24px;">
                <div class="section-header">
                    <h2><span>üìé</span> Attachment Analysis</h2>
                    <span class="source-tag">VirusTotal Hash</span>
                </div>
                <div id="attachmentsList"></div>
            </section>

            <div class="category-label">Behavioral Sandboxing</div>

            <!-- 3. Sandbox Container -->
            <div id="sandboxContainer">
                <div class="section-header" style="margin-bottom: 16px;">
                    <h2><span>üî¨</span> Sandbox Detonation</h2>
                </div>
                <!-- Dynamic cards injected here -->
                <div id="sandboxResultsGrid" style="display: flex; flex-direction: column; gap: 24px;"></div>
                <div id="noSandboxMsg"
                    style="padding: 32px; text-align: center; background: #f9fafb; border-radius: 8px; border: 1px dashed var(--border); color: var(--text-muted); display: none;">
                    No URLs found to detonate.
                </div>
            </div>
        </main>
    </div>

    <!-- Forensic Toolkit Section (Fixed & Streamlined) -->
    <div id="toolkitSection" style="display: none; padding: 24px 40px;">
        <div class="toolkit-dashboard">
            <div class="tool-card span-2">
                <h3><span>üìß Header Analyzer</span></h3>
                <p>Upload file or paste raw headers.</p>
                <div id="headerFileContainer">
                    <div class="drop-area-box" id="headerDropArea"
                        onclick="document.getElementById('headerFileInput').click()"
                        style="padding: 12px; margin: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 80px;">
                        <div style="font-size: 1.5rem; margin-bottom: 4px;">üì•</div>
                        <div style="font-weight: 700; font-size: 0.75rem;">Drop .txt, .eml or Click</div>
                    </div>
                </div>

                <div style="text-align:center; position: relative; margin: 12px 0;">
                    <hr style="border: 0; border-top: 1px solid var(--border); margin: 0;">
                    <span
                        style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: white; padding: 0 8px; color: var(--text-muted); font-size: 0.7rem; font-weight: 700;">OR</span>
                </div>

                <div id="headerTextContainer" style="display:block;">
                    <textarea id="standaloneHeaderInput" class="standalone-input"
                        placeholder="Paste full email headers..."
                        style="min-height:80px; resize:vertical; display:block; font-size:0.75rem;"></textarea>
                </div>

                <input type="file" id="headerFileInput" style="display: none;" accept=".txt,.headers,.eml"
                    onchange="loadHeaderFile(this.files[0])">
                <button class="btn btn-primary" style="margin-top:12px;" onclick="analyzeStandalone('header')">Analyze
                    Headers</button>
            </div>


            <div class="tool-card">
                <h3><span>üìé File Analysis</span></h3>
                <p>Check macros and malware hashes.</p>
                <div id="attachmentFileContainer">
                    <div class="drop-area-box" id="toolkitDropArea"
                        onclick="document.getElementById('standaloneAttachmentInput').click()"
                        style="padding: 12px; margin: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 80px;">
                        <div style="font-size: 1.5rem; margin-bottom: 4px;">üìé</div>
                        <div style="font-weight: 700; font-size: 0.75rem;">Drop or Click</div>
                    </div>
                </div>

                <input type="file" id="standaloneAttachmentInput" style="display: none;"
                    onchange="analyzeStandalone('attachment')">
            </div>

            <div class="tool-card">
                <h3><span>üîó URL Sandbox</span></h3>
                <p>Detonate a URL in our browser sandbox.</p>
                <input type="text" id="standaloneUrlInput" class="standalone-input"
                    placeholder="https://suspicious-link.com">
                <button class="btn btn-primary" onclick="analyzeStandalone('url')">Detonate URL</button>
            </div>

            <div class="tool-card">
                <h3><span>üåê Domain Intelligence</span></h3>
                <p>Check domain age and DNS records.</p>
                <input type="text" id="standaloneDomainInput" class="standalone-input" placeholder="evil-domain.cc">
                <button class="btn btn-primary" onclick="analyzeStandalone('domain')">Check Domain</button>
            </div>

            <div class="tool-card">
                <h3><span>üõ°Ô∏è IP Intelligence</span></h3>
                <p>Check reputation on AbuseIPDB.</p>
                <input type="text" id="standaloneIpInput" class="standalone-input" placeholder="1.2.3.4">
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary" style="flex:1;" onclick="analyzeStandalone('ip')">Check IP</button>
                    <button class="btn btn-outline" style="flex:1; margin:0;"
                        onclick="showReportModal()">Report</button>
                </div>
            </div>

            <div id="toolkitResults" class="card" style="grid-column: 1 / -1; display: none; margin-top: 20px;">
                <div class="section-header" style="margin-bottom: 12px;">
                    <h2 style="font-size: 1rem; margin:0;">Toolkit Result</h2>
                    <button class="btn btn-outline"
                        style="width:auto; padding: 2px 8px; margin:0; font-size: 0.7rem; height: 24px;"
                        onclick="document.getElementById('toolkitResults').style.display='none'">Clear</button>
                </div>
                <div id="toolkitResultsContent"></div>
            </div>
        </div>
    </div>

    <!-- Whitelist Info (Hidden if empty) -->
    <div id="whitelistSection"
        style="max-width: 1200px; margin: 20px auto; padding: 0 32px; color: #7f8c8d; font-size: 0.9em;">
        <strong>Whitelisted Hits (Ignored):</strong> <span id="whitelistHits">None</span>
    </div>

    <script>
        let currentAnalysisData = null;

        function showSection(section) {
            if (section === 'analysis') {
                document.getElementById('analysisSection').style.display = 'grid';
                document.getElementById('toolkitSection').style.display = 'none';
                document.getElementById('navAnalysis').classList.add('active');
                document.getElementById('navToolkit').classList.remove('active');
            } else {
                document.getElementById('analysisSection').style.display = 'none';
                document.getElementById('toolkitSection').style.display = 'grid';
                document.getElementById('navAnalysis').classList.remove('active');
                document.getElementById('navToolkit').classList.add('active');
            }
        }

        async function loadHeaderFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('standaloneHeaderInput').value = e.target.result;
                // Visual feedback
                const dropArea = document.getElementById('headerDropArea');
                if (dropArea) {
                    const originalHtml = dropArea.innerHTML;
                    dropArea.innerHTML = `<div style="font-size: 1.25rem; margin-bottom: 4px;">‚úÖ</div><div style="font-weight: 700; font-size: 0.7rem; color: var(--success);">${file.name} Loaded</div>`;
                    setTimeout(() => { dropArea.innerHTML = originalHtml; }, 3000);
                }
            };
            reader.readAsText(file);
        }

        async function analyzeStandalone(type) {
            const resultsDiv = document.getElementById('toolkitResults');
            const content = document.getElementById('toolkitResultsContent');
            resultsDiv.style.display = 'block';
            content.innerHTML = '<div class="loader" style="display:block;"></div>';
            resultsDiv.scrollIntoView({ behavior: 'smooth' });

            try {
                let res, data;
                if (type === 'header') {
                    res = await fetch('/api/analyze/header', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ headers: document.getElementById('standaloneHeaderInput').value })
                    });
                } else if (type === 'url') {
                    res = await fetch('/api/analyze/url', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: document.getElementById('standaloneUrlInput').value })
                    });
                } else if (type === 'domain') {
                    res = await fetch('/api/analyze/domain', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ domain: document.getElementById('standaloneDomainInput').value })
                    });
                } else if (type === 'ip') {
                    res = await fetch('/api/analyze/ip', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ip: document.getElementById('standaloneIpInput').value })
                    });
                } else if (type === 'attachment') {
                    const fileInput = document.getElementById('standaloneAttachmentInput');
                    let file = fileInput.files[0];

                    if (!file) return;
                    const formData = new FormData();
                    formData.append('file', file);
                    res = await fetch('/api/analyze/attachment', { method: 'POST', body: formData });
                }

                data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Analysis failed');
                renderToolkitResult(type, data);
            } catch (e) {
                content.innerHTML = `<div class="indicator-item" style="color: var(--danger); font-weight: 600;">Error: ${e.message}</div>`;
            }
        }

        function renderToolkitResult(type, data) {
            const content = document.getElementById('toolkitResultsContent');
            content.innerHTML = '';
            if (type === 'header') {
                content.innerHTML = `
                    <h4 style="margin:0 0 24px 0;">Header Analysis (Score: ${data.score})</h4>
                    <ul style="margin-bottom: 24px;">${data.reasons.map(r => `<li>${r}</li>`).join('')}</ul>
                    <h5>Routing Hops</h5>
                    <div class="table-container"><table><thead><tr><th>Hop</th><th>Delay</th><th>Source / IP</th><th>Security Intel</th><th>Timestamp</th></tr></thead>
                    <tbody>${renderHops(data.hops, data.ip_intel)}</tbody></table></div>
                `;
            } else if (type === 'url') {
                let exfilHtml = '';
                if (data.exfiltration_detected) {
                    const ex = data.exfiltration_detected;
                    const p = ex.pillars;
                    const verdictColor = ex.verdict === 'Confirmed' ? 'var(--danger)' : 'var(--warning)';

                    exfilHtml = `
                        <div style="margin-top:24px; padding:20px; background:#fff5f5; border:1px solid #feb2b2; border-radius:12px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                                <h5 style="margin:0; color:#c53030; font-size:0.95rem;">üö© Data Exfiltration Analysis</h5>
                                <span class="badge" style="background:${verdictColor}; color:white;">${ex.verdict}</span>
                            </div>
                            
                            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-bottom:16px;">
                                <div style="text-align:center; padding:10px; background:white; border-radius:8px; border:1px solid ${p.pillar_1.detected ? '#feb2b2' : '#e2e8f0'};">
                                    <div style="font-size:1.1rem; margin-bottom:4px;">${p.pillar_1.detected ? 'üîë' : 'üõ°Ô∏è'}</div>
                                    <div style="font-size:0.65rem; font-weight:bold; color:var(--text-muted);">PILLAR 1</div>
                                    <div style="font-size:0.75rem; color:${p.pillar_1.detected ? 'var(--danger)' : 'var(--success)'}; font-weight:700;">Sensitive Data</div>
                                </div>
                                <div style="text-align:center; padding:10px; background:white; border-radius:8px; border:1px solid ${p.pillar_2.detected ? '#feb2b2' : '#e2e8f0'};">
                                    <div style="font-size:1.1rem; margin-bottom:4px;">${p.pillar_2.detected ? 'üåê' : '‚úÖ'}</div>
                                    <div style="font-size:0.65rem; font-weight:bold; color:var(--text-muted);">PILLAR 2</div>
                                    <div style="font-size:0.75rem; color:${p.pillar_2.detected ? 'var(--danger)' : 'var(--success)'}; font-weight:700;">Unauthorized Target</div>
                                </div>
                                <div style="text-align:center; padding:10px; background:white; border-radius:8px; border:1px solid ${p.pillar_3.detected ? '#feb2b2' : '#e2e8f0'};">
                                    <div style="font-size:1.1rem; margin-bottom:4px;">${p.pillar_3.detected ? 'üïµÔ∏è' : 'üîî'}</div>
                                    <div style="font-size:0.65rem; font-weight:bold; color:var(--text-muted);">PILLAR 3</div>
                                    <div style="font-size:0.75rem; color:${p.pillar_3.detected ? 'var(--danger)' : 'var(--success)'}; font-weight:700;">Stealthy Behavior</div>
                                </div>
                            </div>

                            <div style="font-size:0.8125rem;">
                                <div style="margin-bottom:6px;"><strong>Verdict:</strong> ${p.pillar_1.summary}</div>
                                <div style="margin-bottom:6px;"><strong>Origin Deviance:</strong> ${p.pillar_2.summary}</div>
                                <div><strong>Forensic Pattern:</strong> ${p.pillar_3.summary}</div>
                            </div>
                        </div>
                    `;
                }

                content.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h4 style="margin:0;">Sandbox Finished</h4>
                        <span class="badge" style="background: ${data.score > 70 ? 'var(--danger)' : (data.score > 30 ? 'var(--warning)' : 'var(--success)')}; color:white;">Score: ${data.score}</span>
                    </div>
                    <ul style="margin-bottom: 16px;">${data.reasons.map(r => `<li>${r}</li>`).join('')}</ul>
                    <div style="font-size: 0.8125rem; margin-bottom: 20px; padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                        <strong>Final URL:</strong> <span style="font-family: monospace; word-break: break-all;">${data.expanded_url}</span>
                    </div>
                    <div class="screenshot-container"><img src="/${data.screenshot_path}" style="border-radius:12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"></div>
                    ${exfilHtml}
                `;
            } else if (type === 'domain') {
                const isWhitelisted = data.whitelisted;
                content.innerHTML = `
                    <h4 style="margin:0 0 24px 0;">Domain Intelligence: ${data.domain} ${isWhitelisted ? '<span class="badge" style="background:#10b981; color:white; vertical-align:middle; margin-left:8px;">Whitelisted</span>' : ''}</h4>
                    <div class="indicator-item" style="background: ${isWhitelisted ? '#f0fdf4' : (data.score > 0 ? '#fef2f2' : '#f0fdf4')}">
                        <strong>Score: ${data.score}</strong> - ${data.reason || 'No malicious indicators found'}
                        <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 4px;">Age: ${data.age_days || 'Unknown'} days</div>
                    </div>
                    ${renderDNSInfo(data.intel)}
                `;
            } else if (type === 'attachment') {
                let extraInfo = '';
                if (data.attachment.image_info && Object.keys(data.attachment.image_info).length > 0) {
                    const info = data.attachment.image_info;
                    extraInfo = `
                        <div style="margin-top:16px; padding:12px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px;">
                            <div style="font-weight:700; font-size:0.75rem; color:var(--primary); text-transform:uppercase; margin-bottom:8px;">üñºÔ∏è Image Forensics</div>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; font-size:0.8125rem;">
                                <div><strong>Format:</strong> ${info.format}</div>
                                <div><strong>Dimensions:</strong> ${info.size}</div>
                                <div><strong>Mode:</strong> ${info.mode}</div>
                                <div style="color: ${info.ocr_active ? 'var(--success)' : 'var(--warning)'};">
                                    <strong>OCR:</strong> ${info.ocr_active ? '‚úÖ Active' : '‚ö†Ô∏è Unavailable'}
                                </div>
                            </div>
                        </div>
                    `;
                }

                content.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h4 style="margin:0;">File Scan Results</h4>
                        <span class="badge" style="background: ${data.attachment.risk === 'Clean' ? 'var(--success)' : 'var(--danger)'}; color:white;">${data.attachment.risk}</span>
                    </div>
                    <ul style="margin-bottom: 24px;">${data.reasons.map(r => `<li>${r}</li>`).join('')}</ul>
                    <div class="indicator-item">
                        <div style="font-size:0.65rem; color:var(--text-muted); margin-bottom:6px; font-family:monospace;">Audit Path: ${data.attachment.filename}</div>
                        <strong>Filename:</strong> ${data.attachment.filename}<br>
                        <strong>MD5:</strong> <span style="font-family: monospace;">${data.attachment.md5}</span><br>
                        <strong>VT Detection:</strong> ${data.attachment.vt_stats || 'Not scanned/No hits'}
                    </div>
                    ${data.attachment.extracted_text ? `
                        <div style="margin-top:16px;">
                            <button class="btn btn-outline" style="width:auto; padding:4px 12px; font-size:0.75rem; margin:0;" 
                                onclick="const c = this.nextElementSibling; c.style.display = c.style.display === 'none' ? 'block' : 'none'; this.innerText = c.style.display === 'none' ? 'üëÅÔ∏è Show Parsed Content' : 'Hide Parsed Content'">
                                üëÅÔ∏è Hide Parsed Content
                            </button>
                            <pre style="display:block; margin-top:12px; padding:12px; background:#f1f5f9; border-radius:8px; font-size:0.75rem; white-space:pre-wrap; word-break:break-all; max-height:200px; overflow-y:auto; border:1px solid #e2e8f0; color:#475569;">${data.attachment.extracted_text}</pre>
                        </div>
                    ` : ''}
                    ${extraInfo}
                `;
            } else if (type === 'ip') {
                const rep = data.reputation || {};
                const scoreColor = (rep.abuse_score || 0) >= 50 ? 'var(--danger)' : ((rep.abuse_score || 0) >= 10 ? 'var(--warning)' : 'var(--success)');
                const ip = document.getElementById('standaloneIpInput').value;
                content.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h4 style="margin:0;">AbuseIPDB Intelligence: ${ip}</h4>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <button class="btn btn-outline" style="width: auto; margin: 0; padding: 6px 12px; font-size: 0.75rem;" 
                                onclick="copyToClipboard('IP: ${ip}\\nAbuse Score: ${rep.abuse_score}%\\nISP: ${rep.isp}\\nCountry: ${rep.country || data.geo?.country}')">
                                <span>üìã</span> Copy Intel
                            </button>
                            <span class="badge" style="background: ${scoreColor}; color:white;">Abuse Score: ${rep.abuse_score || 0}%</span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 24px;">
                        <div class="indicator-item">
                            <div style="margin-bottom:8px;"><strong>ISP:</strong> ${rep.isp || 'Unknown'}</div>
                            <div style="margin-bottom:8px;"><strong>Usage:</strong> ${rep.usage_type || 'Unknown'}</div>
                            <div style="margin-bottom:8px;"><strong>Country:</strong> ${rep.country || data.geo?.country || 'Unknown'}</div>
                            <div style="margin-bottom:8px;"><strong>Reports:</strong> ${rep.total_reports || 0} total</div>
                        </div>
                        <div>
                            <h5 style="margin:0 0 12px 0; font-size:0.75rem; text-transform:uppercase; color:var(--text-muted);">Recent Abuse Reports</h5>
                            ${rep.recent_reports?.length ? rep.recent_reports.map(r => `
                                <div style="font-size:0.75rem; padding:8px; border:1px solid var(--border); border-radius:6px; margin-bottom:8px; background:#f9fafb;">
                                    <div style="color:var(--text-muted); font-weight:bold; margin-bottom:4px;">${new Date(r.reportedAt).toLocaleDateString()}</div>
                                    <div style="font-style:italic;">${r.comment}</div>
                                </div>
                            `).join('') : '<div style="color:var(--success); font-size:0.8125rem;">No recent reports found.</div>'}
                        </div>
                    </div>
                `;
            }
        }

        function renderHops(hops, ipIntel) {
            return hops.map(hop => {
                const intel = ipIntel?.[hop.ip];
                let repHtml = "-";
                if (intel && intel.reputation?.abuse_score !== undefined) {
                    const score = intel.reputation.abuse_score;
                    const color = score > 50 ? 'var(--danger)' : (score > 10 ? 'var(--warning)' : 'var(--success)');
                    repHtml = `<div style="color: ${color}; font-weight: 800;">${score}%</div>`;
                    if (intel.geo?.country) repHtml += `<div style="font-size: 0.625rem; color: var(--text-muted);">${intel.geo.city || ''}, ${intel.geo.country}</div>`;
                }
                return `<tr><td style="font-weight: 600;">#${hop.hop}</td><td>${hop.delay}</td><td style="word-break: break-all;"><div>${hop.from}</div><small>${hop.ip}</small></td><td>${repHtml}</td><td style="font-size: 0.75rem;">${hop.time}</td></tr>`;
            }).join('');
        }

        function renderDNSInfo(intel) {
            if (!intel) return '';
            let html = `<div style="font-size: 0.75rem; background: #fff; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-top:16px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                    <span><strong>Registrar:</strong> ${intel.registrar || 'N/A'}</span>
                    <span><strong>VT Reputation:</strong> <span style="color:${intel.reputation < 0 ? 'red' : 'green'}">${intel.reputation}</span></span>
                </div>`;
            if (intel.records && intel.records.length > 0) {
                html += `<div class="table-container"><table><thead><tr><th>Type</th><th>Value</th><th>TTL</th></tr></thead><tbody>`;
                intel.records.forEach(r => {
                    html += `<tr><td>${r.type}</td><td style="word-break: break-all;">${r.value}</td><td>${r.ttl}</td></tr>`;
                });
                html += `</tbody></table></div>`;
            }
            html += `</div>`;
            return html;
        }

        function updateProgress(percent, status) {
            const pbFill = document.getElementById('pbFill');
            const pbStatus = document.getElementById('pbStatus');
            const pbPercent = document.getElementById('pbPercent');
            pbFill.style.width = percent + '%';
            pbStatus.innerText = status;
            pbPercent.innerText = percent + '%';
        }

        async function handleFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) return;

            const pbContainer = document.getElementById('fullAnalysisProgress');
            pbContainer.style.display = 'block';

            const formData = new FormData();
            formData.append('file', file);
            formData.append('analysis_mode', activeAnalysisMode);

            // LOGIC BRANCHING BASED ON MODE
            if (activeAnalysisMode === 'direct') {
                updateProgress(20, "Direct parsing started...");
                await runFinalAnalysis(formData);
            }
            else if (activeAnalysisMode === 'forensic') {
                updateProgress(5, "Inspecting container artifacts...");
                try {
                    const inspectRes = await fetch('/api/inspect/email', { method: 'POST', body: formData });
                    if (!inspectRes.ok) throw new Error("Inspection failed");
                    const inspectData = await inspectRes.json();

                    if (inspectData.attachments && inspectData.attachments.length > 0) {
                        pbContainer.style.display = 'none';
                        showAttachmentModal(inspectData);
                    } else {
                        updateProgress(20, "No nested artifacts, analyzing directly...");
                        await runFinalAnalysis(formData);
                    }
                } catch (err) {
                    console.warn("Forensic inspection failed, falling back to direct:", err);
                    await runFinalAnalysis(formData);
                }
            }
        }

        async function renderReport(data) {
            // Verdict Initial
            ['sidebarVerdictBox', 'mainVerdictBox'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.className = `verdict-banner ${data.verdict}`;
            });
            ['sidebarTotalScore', 'mainTotalScore'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerText = data.total_score;
            });
            ['sidebarVerdictText', 'mainVerdictText'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerText = data.verdict.toUpperCase();
            });

            // Threat Classification Badge
            const threatBadge = document.getElementById('threatBadge');
            if (threatBadge) {
                if (data.verdict !== 'Benign' && (data.threat_type || data.threat_category)) {
                    threatBadge.style.display = 'inline-block';
                    threatBadge.innerText = data.threat_category !== 'None' ? data.threat_category : data.threat_type;
                    threatBadge.style.background = data.verdict === 'Malicious' ? 'var(--danger)' : 'var(--warning)';
                    threatBadge.style.color = 'white';
                } else {
                    threatBadge.style.display = 'none';
                }
            }

            // Verdict Justification (Phase 1 Enhancement)
            if (data.verdict_explanation && data.verdict !== 'Pending') {
                const justCard = document.getElementById('verdictJustificationCard');
                const explainText = document.getElementById('verdictExplanationText');
                const confidenceBadge = document.getElementById('confidenceBadge');
                const riskContainer = document.getElementById('riskFactorsContainer');
                const riskList = document.getElementById('riskFactorsList');

                justCard.style.display = 'block';
                explainText.innerHTML = data.verdict_explanation.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                confidenceBadge.innerText = `Confidence: ${data.confidence_score}%`;

                // Color code confidence
                if (data.confidence_score >= 80) {
                    confidenceBadge.style.background = 'var(--success)';
                } else if (data.confidence_score >= 60) {
                    confidenceBadge.style.background = 'var(--warning)';
                } else {
                    confidenceBadge.style.background = 'var(--text-muted)';
                }

                // Render risk factors
                if (data.risk_factors && data.risk_factors.length > 0) {
                    riskContainer.style.display = 'block';
                    riskList.innerHTML = '';

                    // Group by category
                    const grouped = {};
                    data.risk_factors.forEach(rf => {
                        if (!grouped[rf.category]) grouped[rf.category] = [];
                        grouped[rf.category].push(rf);
                    });

                    // Render each category
                    for (const [category, factors] of Object.entries(grouped)) {
                        const categoryDiv = document.createElement('div');
                        categoryDiv.style.marginBottom = '16px';

                        const categoryTitle = document.createElement('div');
                        categoryTitle.style.fontWeight = '700';
                        categoryTitle.style.fontSize = '0.8125rem';
                        categoryTitle.style.textTransform = 'capitalize';
                        categoryTitle.style.marginBottom = '8px';
                        categoryTitle.style.color = 'var(--text-main)';
                        categoryTitle.innerText = category.replace('_', ' ');
                        categoryDiv.appendChild(categoryTitle);

                        factors.forEach(factor => {
                            const factorDiv = document.createElement('div');
                            factorDiv.style.display = 'flex';
                            factorDiv.style.alignItems = 'flex-start';
                            factorDiv.style.gap = '8px';
                            factorDiv.style.marginBottom = '6px';
                            factorDiv.style.fontSize = '0.8125rem';

                            const severityBadge = document.createElement('span');
                            severityBadge.className = 'badge';
                            severityBadge.style.fontSize = '0.625rem';
                            severityBadge.style.padding = '2px 6px';
                            severityBadge.style.textTransform = 'uppercase';
                            severityBadge.innerText = factor.severity;

                            const severityColors = {
                                'critical': 'var(--danger)',
                                'high': 'var(--warning)',
                                'medium': '#f59e0b',
                                'low': 'var(--text-muted)',
                                'info': 'var(--success)'
                            };
                            severityBadge.style.background = severityColors[factor.severity] || 'var(--text-muted)';
                            severityBadge.style.color = 'white';

                            const evidenceText = document.createElement('span');
                            evidenceText.style.flex = '1';
                            evidenceText.innerText = factor.evidence;

                            factorDiv.appendChild(severityBadge);
                            factorDiv.appendChild(evidenceText);
                            categoryDiv.appendChild(factorDiv);
                        });

                        riskList.appendChild(categoryDiv);
                    }
                } else {
                    riskContainer.style.display = 'none';
                }
            } else {
                document.getElementById('verdictJustificationCard').style.display = 'none';
            }

            // Score Breakdown (Phase 7 Enhancement)
            if (data.score_breakdown && data.score_breakdown.length > 0 && data.verdict !== 'Pending') {
                const breakdownCard = document.getElementById('scoreBreakdownCard');
                const breakdownContent = document.getElementById('scoreBreakdownContent');
                const totalBadge = document.getElementById('totalScoreBadge');

                breakdownCard.style.display = 'block';
                totalBadge.innerText = `Total: ${data.total_score}`;

                // Color code total score
                if (data.total_score >= 71) {
                    totalBadge.style.background = 'var(--danger)';
                } else if (data.total_score >= 31) {
                    totalBadge.style.background = 'var(--warning)';
                } else {
                    totalBadge.style.background = 'var(--success)';
                }

                breakdownContent.innerHTML = '';

                // Group by component
                const grouped = {};
                data.score_breakdown.forEach(item => {
                    if (!grouped[item.component]) grouped[item.component] = [];
                    grouped[item.component].push(item);
                });

                // Render each component group
                for (const [component, items] of Object.entries(grouped)) {
                    const componentDiv = document.createElement('div');
                    componentDiv.style.marginBottom = '20px';

                    const componentTitle = document.createElement('div');
                    componentTitle.style.fontWeight = '700';
                    componentTitle.style.fontSize = '0.875rem';
                    componentTitle.style.marginBottom = '12px';
                    componentTitle.style.display = 'flex';
                    componentTitle.style.justifyContent = 'space-between';
                    componentTitle.style.alignItems = 'center';

                    const titleText = document.createElement('span');
                    titleText.innerText = component;

                    const componentTotal = items.reduce((sum, item) => sum + item.points, 0);
                    const totalBadge = document.createElement('span');
                    totalBadge.className = 'badge';
                    totalBadge.style.background = 'var(--primary)';
                    totalBadge.style.color = 'white';
                    totalBadge.style.fontSize = '0.75rem';
                    totalBadge.innerText = `+${componentTotal} pts`;

                    componentTitle.appendChild(titleText);
                    componentTitle.appendChild(totalBadge);
                    componentDiv.appendChild(componentTitle);

                    items.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.style.marginBottom = '10px';

                        const itemHeader = document.createElement('div');
                        itemHeader.style.display = 'flex';
                        itemHeader.style.justifyContent = 'space-between';
                        itemHeader.style.marginBottom = '4px';
                        itemHeader.style.fontSize = '0.8125rem';

                        const reasonText = document.createElement('span');
                        reasonText.style.flex = '1';
                        reasonText.style.marginRight = '12px';
                        reasonText.innerText = item.reason;

                        const pointsText = document.createElement('span');
                        pointsText.style.fontWeight = '700';
                        pointsText.style.color = 'var(--primary)';
                        pointsText.innerText = `+${item.points}`;

                        itemHeader.appendChild(reasonText);
                        itemHeader.appendChild(pointsText);
                        itemDiv.appendChild(itemHeader);

                        // Progress bar
                        const progressBg = document.createElement('div');
                        progressBg.style.width = '100%';
                        progressBg.style.height = '6px';
                        progressBg.style.background = 'var(--border)';
                        progressBg.style.borderRadius = '3px';
                        progressBg.style.overflow = 'hidden';

                        const progressFill = document.createElement('div');
                        progressFill.style.height = '100%';
                        progressFill.style.width = `${Math.min((item.points / data.total_score) * 100, 100)}%`;
                        progressFill.style.background = item.points >= 40 ? 'var(--danger)' : (item.points >= 20 ? 'var(--warning)' : 'var(--primary)');
                        progressFill.style.transition = 'width 0.3s ease';

                        progressBg.appendChild(progressFill);
                        itemDiv.appendChild(progressBg);
                        componentDiv.appendChild(itemDiv);
                    });

                    breakdownContent.appendChild(componentDiv);
                }
            } else {
                document.getElementById('scoreBreakdownCard').style.display = 'none';
            }

            // Sender Reputation (AbuseIPDB)
            try {
                const senderRepBox = document.getElementById('senderReputationBox');
                if (senderRepBox) {
                    const hops = data.hops || [];
                    const lastHop = hops[hops.length - 1];
                    const ip = lastHop ? lastHop.ip : 'Unknown';
                    const intel = data.ip_intel?.[ip];

                    if (intel && (intel.reputation || intel.abuse_score !== undefined)) {
                        const score = intel.abuse_score !== undefined ? intel.abuse_score : (intel.reputation.abuse_score || 0);
                        const color = score > 50 ? 'var(--danger)' : (score > 10 ? 'var(--warning)' : 'var(--success)');
                        senderRepBox.innerHTML = `
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <span style="font-size:0.875rem; font-weight:700;">${ip}</span>
                                <span class="badge" style="background:${color}; color:white;">Score: ${score}%</span>
                            </div>
                            <div style="font-size:0.8125rem; color:var(--text-muted);">
                                <strong>ISP:</strong> ${intel.isp || intel.reputation?.isp || 'N/A'}<br>
                                <strong>Country:</strong> ${intel.geo?.country || intel.country_name || 'N/A'}<br>
                                <strong>Reports:</strong> ${intel.reports || intel.reputation?.reports || 0} hits
                            </div>
                        `;
                    } else {
                        senderRepBox.innerHTML = '<div style="color:var(--text-muted); font-size:0.8125rem;">No reputation data available for sender IP.</div>';
                    }
                }
            } catch (e) {
                console.error("Error rendering Sender Reputation:", e);
            }

            // Auth Results
            try {
                const authDiv = document.getElementById('headerAuthIcons');
                if (authDiv) {
                    authDiv.innerHTML = '';
                    if (data.auth_results) {
                        const makeIcon = (label, status) => {
                            const s = (status || '').toLowerCase();
                            const isPass = s === 'pass';
                            const isFail = s.includes('fail');
                            const color = isPass ? 'var(--success)' : (isFail ? 'var(--danger)' : 'var(--text-muted)');
                            return `<div style="text-align:center; background:#f9fafb; padding:12px; border-radius:8px; border:1px solid var(--border); min-width:80px; flex:1;">
                                <div style="font-size:1.25rem; font-weight:bold; color:${color};">${isPass ? '‚úì' : (isFail ? '‚ö†' : '?')}</div>
                                <div style="font-size:0.75rem; font-weight:700; color:var(--text-muted); margin-top:4px;">${label}</div>
                                <div style="font-size:0.625rem; color:${color}; font-weight:800;">${(status || 'NONE').toUpperCase()}</div>
                            </div>`;
                        };
                        authDiv.innerHTML += makeIcon('SPF', data.auth_results.spf?.status);
                        authDiv.innerHTML += makeIcon('DKIM', data.auth_results.dkim?.status);
                        authDiv.innerHTML += makeIcon('DMARC', data.auth_results.dmarc?.status);
                    }
                }
            } catch (e) {
                console.error("Error rendering Auth Results:", e);
            }

            // MxToolbox
            try {
                const mx = data.mxtoolbox_analysis;
                const mxSection = document.getElementById('mxToolboxSection');
                if (mx && typeof mx === 'object' && Object.keys(mx).length > 0) {
                    mxSection.style.display = 'block';
                    const container = document.getElementById('mxResults');
                    container.innerHTML = '';
                    ['blacklist', 'smtp', 'spf', 'dmarc', 'dns'].forEach(key => {
                        const monitorData = mx[key];
                        if (!monitorData || (!monitorData.details?.length && monitorData.passed)) return;
                        const sec = document.createElement('div');
                        sec.style.marginBottom = '12px';
                        const color = monitorData.passed ? 'var(--success)' : 'var(--danger)';
                        let html = `<div style="background:${monitorData.passed ? '#f0fdf4' : '#fef2f2'}; padding:6px 10px; border-radius:6px; display:flex; align-items:center; gap:8px; font-size:0.75rem;">
                                <span style="color:${color}; font-weight:bold;">${monitorData.passed ? '‚úì' : '‚úó'}</span>
                                <span style="font-weight:700; color:${color}; text-transform:uppercase;">${key.toUpperCase()}</span>
                            </div>`;
                        sec.innerHTML = html;
                        container.appendChild(sec);
                    });
                    if (container.innerHTML === '') mxSection.style.display = 'none';
                } else { mxSection.style.display = 'none'; }
            } catch (e) {
                console.error("Error rendering MxToolbox Section:", e);
            }

            // Hops
            try {
                const hopsB = document.getElementById('headerHopsTableBody');
                if (hopsB) {
                    hopsB.innerHTML = '';
                    if (data.hops && data.hops.length > 0) {
                        data.hops.map(hop => {
                            const intel = data.ip_intel?.[hop.ip];
                            let repHtml = "-";
                            if (intel) {
                                const score = intel.abuse_score !== undefined ? intel.abuse_score : (intel.reputation?.abuse_score || 0);
                                if (score !== undefined) {
                                    const color = score > 50 ? 'var(--danger)' : (score > 10 ? 'var(--warning)' : 'var(--success)');
                                    repHtml = `<div style="color:${color}; font-weight:800;">${score}%</div>`;
                                }
                            }
                            hopsB.innerHTML += `<tr><td style="font-weight:600;">#${hop.hop}</td><td style="color:${parseInt(hop.delay) > 10 ? 'var(--danger)' : 'inherit'};">${hop.delay}</td><td style="word-break:break-all;"><div>${hop.from || 'unknown'}</div><small>${hop.ip}</small></td><td>${repHtml}</td><td>${hop.time || 'N/A'}</td></tr>`;
                        });
                    } else { hopsB.innerHTML = '<tr><td colspan="5" style="text-align:center;">No relay evidence found</td></tr>'; }
                }
            } catch (e) {
                console.error("Error rendering Delivery Hops:", e);
            }

            // VT Detailed Radar
            try {
                const vtRadar = document.getElementById('vtRadarSection');
                const vtDetail = document.getElementById('vtDetailedIntel');
                if (data.url_intel && typeof data.url_intel === 'object' && Object.keys(data.url_intel).length > 0) {
                    vtRadar.style.display = 'block';
                    vtDetail.innerHTML = '';
                    for (const [target, intel] of Object.entries(data.url_intel)) {
                        const hits = intel.hits !== undefined ? intel.hits : (intel.malicious || 0);
                        const hitColor = hits > 5 ? 'var(--danger)' : (hits > 0 ? 'var(--warning)' : 'var(--success)');
                        vtDetail.innerHTML += `
                            <div class="indicator-item" style="border-left:4px solid ${hitColor};">
                                <div style="font-size:0.75rem; font-weight:700; word-break:break-all;">${target}</div>
                                <div style="display:flex; justify-content:space-between; margin-top:4px;">
                                    <span style="font-size:0.7rem; color:var(--text-muted);">${(intel.type || 'target').toUpperCase()} | ${intel.age || intel.age_days || '?'} Days</span>
                                    <span class="badge" style="background:${hitColor}; color:white;">Detections: ${hits}</span>
                                </div>
                            </div>
                        `;
                    }
                } else { vtRadar.style.display = 'none'; }
            } catch (e) {
                console.error("Error rendering VT Radar Section:", e);
            }

            // Suspicious Domains
            const domSection = document.getElementById('suspiciousDomainsSection');
            const domList = document.getElementById('suspiciousDomainsList');
            if (data.suspicious_domains && data.suspicious_domains.length > 0) {
                domSection.style.display = 'block';
                domList.innerHTML = data.suspicious_domains.map(dom => {
                    const age = data.domain_age_days?.[dom] || 'Unknown';
                    const color = age === 'Unknown' || age < 30 ? 'var(--danger)' : 'var(--warning)';
                    return `<li class="indicator-item" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <div>
                            <div style="font-weight:700; font-size:0.875rem;">${dom}</div>
                            <div style="font-size:0.7rem; color:var(--text-muted);">Age: ${age} days</div>
                        </div>
                        <span class="badge" style="background:${color}; color:white;">RISK</span>
                    </li>`;
                }).join('');
            } else { domSection.style.display = 'none'; }

            // Static HTML Forensics
            const htmlSection = document.getElementById('htmlForensicsSection');
            const jsList = document.getElementById('jsIndicatorList');
            const formContainer = document.getElementById('detectedFormsList');
            if (data.html_analysis && (data.html_analysis.js_indicators?.length || data.html_analysis.forms?.length)) {
                htmlSection.style.display = 'block';
                jsList.innerHTML = data.html_analysis.js_indicators?.length
                    ? data.html_analysis.js_indicators.map(i => `<div class="indicator-item" style="font-size:0.75rem; color:var(--danger); border:none; padding:4px 0; margin:0;">‚ö†Ô∏è ${i}</div>`).join('')
                    : '<div style="color:var(--success); font-size:0.75rem;">No suspicious JS detected.</div>';

                formContainer.innerHTML = '';
                if (data.html_analysis.forms?.length) {
                    data.html_analysis.forms.forEach(form => {
                        formContainer.innerHTML += `
                            <div class="indicator-item" style="background:#f9fafb; border:1px solid var(--border); padding:8px; margin:0;">
                                <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                    <span class="badge" style="background:var(--primary); color:white; font-size:0.6rem;">${form.method}</span>
                                    <span style="font-size:0.65rem; color:var(--text-muted); font-weight:bold;">Target: ${form.target_type}</span>
                                </div>
                                <div style="font-size:0.75rem; word-break:break-all; font-family:monospace; margin-bottom:4px;">${form.action || '[No Action]'}</div>
                            </div>
                        `;
                    });
                } else { formContainer.innerHTML = '<div style="color:var(--success); font-size:0.75rem;">No forms detected.</div>'; }
            } else { htmlSection.style.display = 'none'; }

            // Attachments
            const attDiv = document.getElementById('attachmentsList');
            attDiv.innerHTML = '';
            if (data.attachments?.length) {
                data.attachments.forEach(att => {
                    attDiv.innerHTML += `
                        <div class="indicator-item">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div style="font-size:0.8125rem;">
                                    <strong>${att.filename}</strong><br>
                                    <small style="color:var(--text-muted); font-family:monospace;">${att.md5}</small>
                                </div>
                                <span class="badge" style="background:${att.risk === 'Clean' ? 'var(--success)' : 'var(--danger)'}; color:white;">${att.risk}</span>
                            </div>

                            ${att.image_info ? `
                                <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
                                    <span class="badge" style="background:var(--primary); color:white; font-size:0.65rem;">üñºÔ∏è ${att.image_info.format}</span>
                                    <span class="badge" style="background:#f1f5f9; color:var(--text-main); font-size:0.65rem; border:1px solid var(--border);">üìè ${att.image_info.size}</span>
                                    <span class="badge" style="background:${att.image_info.ocr_active ? '#ecfdf5' : '#fef2f2'}; color:${att.image_info.ocr_active ? '#059669' : '#b91c1c'}; font-size:0.65rem; border:1px solid ${att.image_info.ocr_active ? '#10b981' : '#ef4444'};">
                                        ${att.image_info.ocr_active ? '‚úÖ OCR Active' : '‚ùå OCR Unavailable'}
                                    </span>
                                </div>
                            ` : ''}

                            ${att.forensics ? `
                                <div style="margin-top:10px; border-top:1px dashed var(--border); padding-top:8px;">
                                    <div style="font-size:0.75rem; font-weight:700; color:var(--text-muted); margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px; display:flex; align-items:center; gap:6px;">
                                        ‚ö° DESAS Deep Forensics 
                                        ${att.forensics.high_entropy ? '<span title="High Entropy (Packed?)" style="cursor:help;">üé≤</span>' : ''}
                                        ${att.forensics.obfuscation ? '<span title="Obfuscation Detected" style="cursor:help;">üé≠</span>' : ''}
                                    </div>

                                    <div style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px;">
                                        ${att.forensics.mitre_techniques && att.forensics.mitre_techniques.length ?
                                att.forensics.mitre_techniques.map(t => `<span class="badge" style="background:#4c1d95; color:white; font-size:0.65rem;">üõ°Ô∏è ${t}</span>`).join('') : ''}
                                        
                                        ${att.forensics.structural_anomalies && att.forensics.structural_anomalies.length ?
                                `<span class="badge" style="background:#be123c; color:white; font-size:0.65rem;">üèóÔ∏è Malformed Structure</span>` : ''}
                                         
                                         ${att.forensics.pdf_flags && att.forensics.pdf_flags.length ?
                                att.forensics.pdf_flags.map(f => `<span class="badge" style="background:#be185d; color:white; font-size:0.65rem;">üìÑ ${f}</span>`).join('') : ''}
                                            
                                         ${att.forensics.image_flags && att.forensics.image_flags.length ?
                                att.forensics.image_flags.map(f => `<span class="badge" style="background:#0f766e; color:white; font-size:0.65rem;">üñºÔ∏è ${f}</span>`).join('') : ''}
                                    </div>

                                    ${(att.forensics.auto_exec || att.forensics.obfuscation || att.forensics.staging_logic) ? `
                                        <div style="background:#fff7ed; border:1px solid #ffedd5; padding:6px; border-radius:4px; margin-bottom:6px;">
                                            <div style="font-size:0.65rem; color:#c2410c; font-weight:bold; margin-bottom:4px;">BEHAVIORAL INSIGHTS</div>
                                            <ul style="margin:0; padding-left:16px; font-size:0.7rem; color:#9a3412;">
                                                ${att.forensics.auto_exec ? '<li>Auto-Execution Logic Identified</li>' : ''}
                                                ${att.forensics.obfuscation ? '<li>Code Obfuscation / Evasion Techniques</li>' : ''}
                                                ${att.forensics.staging_logic ? '<li>Payload Staging / Dropper Behavior</li>' : ''}
                                            </ul>
                                        </div>
                                    ` : ''}

                                    ${att.forensics.suspicious_calls && att.forensics.suspicious_calls.length ? `
                                        <div style="font-size:0.65rem; color:var(--danger); font-family:monospace; background:#fef2f2; padding:4px; border-radius:4px;">
                                            <strong>Suspicious Calls:</strong> ${att.forensics.suspicious_calls.join(', ')}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}

                            ${att.has_macros ? `
                                <div style="margin-top:10px; padding:8px; background:#fef2f2; border:1px solid #ef4444; border-radius:6px; color:#b91c1c; font-size:0.75rem; font-weight:700; display:flex; align-items:center; gap:8px;">
                                    <span>‚ö†Ô∏è</span> CRITICAL: Embedded Macros Detected (Active Content)
                                </div>
                            ` : ''}

                            ${att.extracted_text ? `
                                <div style="margin-top:10px;">
                                    <div style="font-size:0.65rem; color:var(--text-muted); margin-bottom:4px; font-family:monospace;">Audit Path: ${att.filename}</div>
                                    <button class="btn btn-outline" style="width:auto; padding:2px 8px; font-size:0.65rem; margin:0;" 
                                        onclick="const c = this.nextElementSibling; c.style.display = c.style.display === 'none' ? 'block' : 'none'; this.innerText = c.style.display === 'none' ? 'üëÅÔ∏è Show Parsed Content' : 'Hide Parsed Content'">
                                        üëÅÔ∏è Hide Parsed Content
                                    </button>
                                    <pre style="display:block; margin-top:8px; padding:10px; background:#f1f5f9; border-radius:6px; font-size:0.7rem; white-space:pre-wrap; word-break:break-all; max-height:150px; overflow-y:auto; border:1px solid #e2e8f0; color:#475569;">${att.extracted_text}</pre>
                                </div>
                            ` : ''}
                        </div>`;
                });
            } else { attDiv.innerHTML = '<div style="color:var(--text-muted); font-size:0.8125rem; font-style:italic;">No attachments found.</div>'; }


            document.getElementById('overlaySubject').innerText = data.subject || 'N/A';
            document.getElementById('overlayTimestamp').innerText = data.date || 'N/A';
            document.getElementById('overlaySender').innerText = data.sender || 'Unknown';
            document.getElementById('overlayAttachments').innerText = data.attachments?.length || 0;

            // Block Recommendations
            const blockList = document.getElementById('blockActions');
            blockList.innerHTML = '';
            if (data.block_recommendations?.length) {
                data.block_recommendations.forEach(rec => { blockList.innerHTML += `<li style="color:var(--danger); font-size:0.8125rem; font-weight:700; margin-bottom:6px;">üõ°Ô∏è ${rec}</li>`; });
            } else { blockList.innerHTML = '<li style="color:var(--text-muted); font-size:0.8125rem; font-style:italic;">None.</li>'; }

            // Clear sandbox grid for new analysis
            document.getElementById('sandboxResultsGrid').innerHTML = '';
        }

        function renderSandboxSection(results) {
            const grid = document.getElementById('sandboxResultsGrid');
            const noMsg = document.getElementById('noSandboxMsg');
            grid.innerHTML = '';
            if (!results || results.length === 0) { noMsg.style.display = 'block'; return; }
            noMsg.style.display = 'none';
            results.forEach((sb, idx) => {
                const card = document.createElement('section');
                card.className = 'card';
                card.id = `sandbox-card-${idx}`;
                card.style.opacity = sb.status === 'pending' ? '0.7' : '1';
                card.innerHTML = renderSandboxCardHtml(sb, idx);
                grid.appendChild(card);
            });
        }

        function renderSandboxCardHtml(sb, idx) {
            const isLoading = sb.status === 'pending';
            const scoreColor = sb.score > 70 ? 'var(--danger)' : (sb.score > 30 ? 'var(--warning)' : 'var(--success)');
            return `
                <div class="section-header">
                    <h3 style="font-size:1rem; color:var(--text-main); display:flex; align-items:center; gap:8px;">
                        <span>üîó</span> Sandbox #${idx + 1} ${isLoading ? '<div class="loader" style="display:inline-block; width:12px; height:12px; border-width:2px; margin:0 8px;"></div>' : ''}
                    </h3>
                    <span class="badge" style="background:${isLoading ? '#f3f4f6' : scoreColor}; color:${isLoading ? '#374151' : 'white'};">${isLoading ? 'Analyzing...' : 'Score: ' + sb.score}</span>
                </div>
                <div style="margin-bottom:16px;"><code style="background:#f9fafb; padding:4px 8px; border-radius:4px; border:1px solid var(--border); word-break:break-all; font-size:0.8125rem;">${sb.url}</code></div>
                ${isLoading ? `<div style="height:60px; display:flex; align-items:center; justify-content:center; background:#f9fafb; border-radius:8px; border:1px dashed var(--border); color:var(--text-muted); font-size:0.8125rem;">Running behavioral forensics...</div>` : `
                    <div style="display:grid; grid-template-columns:1fr 1.5fr; gap:24px;">
                        <div>
                            <h4 style="font-size:0.75rem; text-transform:uppercase; color:var(--text-muted); margin-bottom:8px;">Forensic Indicators</h4>
                            <ul style="list-style:none; padding:0; margin:0; font-size:0.8125rem;">${sb.reasons.length ? sb.reasons.map(r => `<li style="margin-bottom:4px;">‚ö†Ô∏è ${r}</li>`).join('') : '<li style="color:var(--success);">No flags.</li>'}</ul>
                            
                            ${sb.exfiltration_detected ? `
                                <div style="margin-top:16px; padding:8px; background:#fff5f5; border:1px solid #feb2b2; border-radius:8px;">
                                    <div style="font-size:0.65rem; font-weight:bold; color:#c53030; margin-bottom:6px;">DATA EXFILTRATION PILLARS</div>
                                    <div style="display:flex; gap:12px; margin-bottom:8px;">
                                        <div title="Sensitive Data: ${sb.exfiltration_detected.pillars.pillar_1.summary}">
                                            <span style="font-size:1.1rem;">${sb.exfiltration_detected.pillars.pillar_1.detected ? 'üîë' : 'üõ°Ô∏è'}</span>
                                        </div>
                                        <div title="Unauthorized Target: ${sb.exfiltration_detected.pillars.pillar_2.summary}">
                                            <span style="font-size:1.1rem;">${sb.exfiltration_detected.pillars.pillar_2.detected ? 'üåê' : '‚úÖ'}</span>
                                        </div>
                                        <div title="Stealthy Behavior: ${sb.exfiltration_detected.pillars.pillar_3.summary}">
                                            <span style="font-size:1.1rem;">${sb.exfiltration_detected.pillars.pillar_3.detected ? 'üïµÔ∏è' : 'üîî'}</span>
                                        </div>
                                    </div>
                                    <div style="font-size:0.7rem; color:#c53030; font-weight:600;">Verdict: ${sb.exfiltration_detected.verdict}</div>
                                </div>
                            ` : ''}
                        </div>
                        <div style="grid-column:span 1; overflow-x:auto; white-space:nowrap; padding:12px; background:#f9fafb; border-radius:8px; border:1px solid var(--border);">
                            <div style="display:flex; gap:12px;">${sb.screenshot_chain.length ? sb.screenshot_chain.map(shot => `<div style="flex:0 0 240px; background:white; border-radius:6px; border:1px solid var(--border); overflow:hidden;"><div style="font-size:0.6rem; color:var(--text-muted); background:#f3f4f6; padding:4px 8px; overflow:hidden;">${shot.label}</div><a href="${shot.url}" target="_blank"><img src="/${shot.path}?t=${new Date().getTime()}" style="width:100%;"></a></div>`).join('') : 'No screenshots.'}</div>
                        </div>
                    </div>`}
            `;
        }

        function updateSandboxCard(idx, data) {
            const card = document.getElementById(`sandbox-card-${idx}`);
            if (card) { card.style.opacity = '1'; card.innerHTML = renderSandboxCardHtml(data, idx); }
        }

        function recalculateTotalVerdict() {
            if (!currentAnalysisData) return;
            let sbScore = 0;
            let allSandboxDone = true;
            currentAnalysisData.sandbox_results.forEach(sb => {
                sbScore += sb.score;
                if (sb.status === 'pending') allSandboxDone = false;
            });

            const totalScore = currentAnalysisData.header_score + currentAnalysisData.body_score + sbScore;
            ['sidebarTotalScore', 'mainTotalScore'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerText = totalScore;
            });

            const vboxS = document.getElementById('sidebarVerdictBox');
            const vboxM = document.getElementById('mainVerdictBox');
            let verdict = totalScore >= 71 ? "Malicious" : (totalScore >= 31 ? "Suspicious" : "Benign");
            if (vboxS) vboxS.className = `verdict-banner ${verdict}`;
            if (vboxM) vboxM.className = `verdict-banner ${verdict}`;

            ['sidebarVerdictText', 'mainVerdictText'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerText = allSandboxDone ? verdict.toUpperCase() : `Analyzing... (${totalScore})`;
            });

            // Update Threat Badge (Live)
            const threatBadge = document.getElementById('threatBadge');
            if (threatBadge && allSandboxDone) {
                // Approximate re-calculation or rely on final verdict
                if (verdict !== 'Benign') {
                    threatBadge.style.display = 'inline-block';
                    threatBadge.style.background = verdict === 'Malicious' ? 'var(--danger)' : 'var(--warning)';
                    // Text will be finalized when full data arrives, for now keep what we have
                } else {
                    threatBadge.style.display = 'none';
                }
            }

        }

        async function downloadReport() {
            if (!currentAnalysisData) return;
            const btn = document.getElementById('downloadBtn');
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span>‚è≥</span> Generating PDF...';

            try {
                const res = await fetch('/api/report/pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentAnalysisData)
                });

                if (!res.ok) throw new Error("PDF generation failed");

                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                const safeSubject = (currentAnalysisData.subject || 'DESAS_Report').replace(/[^a-z0-9]/gi, '_').substring(0, 30);
                a.download = `DESAS_Report_${safeSubject}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (e) {
                alert("Error downloading PDF: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                const toast = document.createElement('div');
                toast.innerText = 'üìã Copied to clipboard!';
                toast.style = 'position:fixed; bottom:20px; right:20px; background:var(--success); color:white; padding:12px 24px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1); z-index:10000; font-weight:bold; animation: slideUp 0.3s ease;';
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 2000);
            } catch (err) {
                alert('Failed to copy: ' + err);
            }
        }


        async function addDomain(domain) {
            if (!confirm(`Add ${domain} to whitelist?`)) return;
            try {
                const res = await fetch('/api/whitelist', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ domain: domain }) });
                if (res.ok) { alert('Domain added!'); location.reload(); }
            } catch (e) { alert("Error adding domain"); }
        }

        async function getSHA256(text) {
            const msgUint8 = new TextEncoder().encode(text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function copyFullReport() {
            if (!currentAnalysisData) return;
            const summary = `
DESAS ANALYSIS REPORT
---------------------
Subject: ${currentAnalysisData.subject || 'N/A'}
Sender: ${currentAnalysisData.sender || 'N/A'}
Score: ${currentAnalysisData.total_score}
Verdict: ${currentAnalysisData.verdict}
Threat Type: ${currentAnalysisData.threat_type}

Indicators:
${currentAnalysisData.risk_reasons.map(r => '‚Ä¢ ' + r).join('\n')}

Generated by DESAS Forensic Workstation
            `.trim();
            copyToClipboard(summary);
        }

        function fillList(id, items, color) {
            const ul = document.getElementById(id);
            if (!ul) return;
            ul.innerHTML = items?.length ? items.map(txt => `<li ${color ? `style="color:${color}"` : ''}>${txt}</li>`).join('') : '<li class="safe-li">No issues detected.</li>';
        }

        // Precise Drag & Drop Handling
        const dropZone = document.getElementById('drop-zone');
        const sidebarDrop = document.getElementById('sidebarDropArea');
        const toolkitDrop = document.getElementById('toolkitDropArea');
        const headerDrop = document.getElementById('headerDropArea');

        window.addEventListener('dragenter', e => {
            e.preventDefault();
            if (e.dataTransfer.types.includes('Files')) {
                dropZone.classList.add('active');
            }
        });

        window.addEventListener('dragover', e => {
            e.preventDefault();
        });

        window.addEventListener('dragleave', e => {
            if (e.relatedTarget === null || e.relatedTarget === sidebarDrop || e.relatedTarget === toolkitDrop) {
                dropZone.classList.remove('active');
            }
        });

        window.addEventListener('drop', e => {
            e.preventDefault();
            dropZone.classList.remove('active');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                // If toolkit is active, try to route to toolkit if appropriate?
                // For now, let's check if the toolkit section is visible
                const isToolkitVisible = document.getElementById('toolkitSection').style.display === 'grid';
                if (isToolkitVisible) {
                    document.getElementById('standaloneAttachmentInput').files = files;
                    analyzeStandalone('attachment');
                } else {
                    document.getElementById('fileInput').files = files;
                    handleFile();
                }
            }
        });

        // Specific hover states
        [sidebarDrop, toolkitDrop, headerDrop].forEach(el => {
            if (!el) return;
            el.addEventListener('dragover', () => el.classList.add('dragover'));
            el.addEventListener('dragleave', () => el.classList.remove('dragover'));
            el.addEventListener('drop', (e) => {
                el.classList.remove('dragover');
                if (el === headerDrop) {
                    const files = e.dataTransfer.files;
                    if (files.length > 0) loadHeaderFile(files[0]);
                }
            });
        });
    </script>

    <!-- Report IP Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 8px;">üì¢ Report Abusive IP</h2>
            <p style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 24px;">Contribute to community
                security by reporting this IP to AbuseIPDB.</p>

            <div class="form-group" style="margin-bottom: 20px;">
                <label>IP Address</label>
                <input type="text" id="reportIpAddr" readonly style="background: #f9fafb; cursor: not-allowed;">
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label>Categories</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.75rem;">
                    <label style="font-weight: normal;"><input type="checkbox" value="18" checked
                            style="width:auto; margin-right:4px;"> Brute-Force</label>
                    <label style="font-weight: normal;"><input type="checkbox" value="19"
                            style="width:auto; margin-right:4px;"> Bad Web Bot</label>
                    <label style="font-weight: normal;"><input type="checkbox" value="21"
                            style="width:auto; margin-right:4px;"> Data Exfiltration</label>
                    <label style="font-weight: normal;"><input type="checkbox" value="22"
                            style="width:auto; margin-right:4px;"> SSH Brute-Force</label>
                    <label style="font-weight: normal;"><input type="checkbox" value="15"
                            style="width:auto; margin-right:4px;"> Phishing</label>
                    <label style="font-weight: normal;"><input type="checkbox" value="11"
                            style="width:auto; margin-right:4px;"> LFI/RFI</label>
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 24px;">
                <label>Comment</label>
                <textarea id="reportComment" class="standalone-input" rows="3"
                    placeholder="Describe the activity (e.g., 'Phishing site targeting bank employees')"></textarea>
            </div>

            <div style="display: flex; gap: 12px;">
                <button class="btn btn-primary" onclick="submitReport()">Submit Report</button>
                <button class="btn btn-outline" style="margin: 0; flex: 1;" onclick="hideReportModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        function showReportModal() {
            const ip = document.getElementById('standaloneIpInput').value.trim();
            if (!ip) { alert("Please enter an IP address first"); return; }
            document.getElementById('reportIpAddr').value = ip;
            document.getElementById('reportModal').style.display = 'flex'; // Use flex to center
        }

        function hideReportModal() {
            document.getElementById('reportModal').style.display = 'none';
        }

        async function submitReport() {
            const ip = document.getElementById('reportIpAddr').value;
            const comment = document.getElementById('reportComment').value;
            const checkboxes = document.querySelectorAll('#reportModal input[type="checkbox"]:checked');
            const categories = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (categories.length === 0) { alert("Please select at least one category"); return; }
            if (!comment) { alert("Please provide a comment"); return; }

            try {
                const res = await fetch('/api/report/ip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip, categories, comment })
                });
                const data = await res.json();
                if (res.ok) {
                    alert("Report submitted successfully! Thank you for your contribution.");
                    hideReportModal();
                } else {
                    alert("Error: " + (data.detail || "Submission failed"));
                }
            } catch (e) {
                alert("Network error: " + e.message);
            }
        }
    </script>

    <!-- Attachment Selection Modal -->
    <div id="attachmentModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:24px;">
                <div>
                    <h2 style="margin:0;">üì¶ Attachment Classifier</h2>
                    <p style="font-size: 0.8125rem; color: var(--text-muted); margin-top:4px;">Select the artifacts you
                        wish to analyze.</p>
                </div>
                <div id="fileTypeBadge" class="badge"
                    style="background:var(--primary); color:white; padding:4px 12px; font-size:0.75rem;">.MSG Container
                </div>
            </div>

            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Filename</th>
                            <th style="width: 120px;">Size</th>
                            <th style="width: 200px; text-align: center;">Role Assignment</th>
                        </tr>
                    </thead>
                    <tbody id="attachmentTableBody">
                        <!-- Dynamic Content -->
                    </tbody>
                </table>
            </div>

            <div
                style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border); display: flex; gap: 12px;">
                <button class="btn btn-primary" onclick="confirmAttachmentSelection()">
                    <span>üöÄ</span> Analyze Selected
                </button>
                <button class="btn btn-outline" style="margin:0; flex:1;" onclick="hideAttachmentModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = null;
        let selectedTarget = null;
        let selectedHeader = null;

        function showAttachmentModal(data) {
            currentSessionId = data.session_id;
            const body = document.getElementById('attachmentTableBody');
            body.innerHTML = '';

            selectedTarget = null;
            selectedHeader = null;

            data.attachments.forEach((att, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:600; font-size:0.875rem;">${att.filename}</td>
                    <td>${(att.size / 1024).toFixed(1)} KB</td>
                    <td>
                        <div style="display: flex; background: #f1f5f9; border-radius: 6px; padding: 2px; gap: 2px;">
                            <button class="role-btn" onclick="setRole('${att.filename}', 'target', this)" style="flex:1; border:none; padding:4px; font-size:0.75rem; border-radius:4px; cursor:pointer; background:transparent; font-weight:600;">Target</button>
                            <button class="role-btn" onclick="setRole('${att.filename}', 'header', this)" style="flex:1; border:none; padding:4px; font-size:0.75rem; border-radius:4px; cursor:pointer; background:transparent; font-weight:600;">Header</button>
                            <button class="role-btn active" onclick="setRole('${att.filename}', 'none', this)" style="flex:1; border:none; padding:4px; font-size:0.75rem; border-radius:4px; cursor:pointer; background:var(--card-bg); box-shadow:0 1px 2px rgba(0,0,0,0.1); font-weight:600;">None</button>
                        </div>
                    </td>
                `;
                body.appendChild(tr);
            });

            document.getElementById('attachmentModal').style.display = 'flex';
        }

        function setRole(filename, role, btn) {
            // Reset siblings in this row
            const row = btn.closest('div');
            row.querySelectorAll('.role-btn').forEach(b => {
                b.classList.remove('active');
                b.style.background = 'transparent';
                b.style.boxShadow = 'none';
            });

            // Set this button active
            btn.classList.add('active');
            btn.style.background = 'var(--card-bg)';
            btn.style.boxShadow = '0 1px 2px rgba(0,0,0,0.1)';

            // Global Selection Logic (only one target/header allowed)
            if (role === 'target') {
                // Clear previous target selections in other rows
                const allRows = document.getElementById('attachmentTableBody').querySelectorAll('tr');
                allRows.forEach(r => {
                    const tBtn = r.querySelector('button[onclick*="\'target\'"]');
                    if (tBtn && tBtn !== btn && tBtn.classList.contains('active')) {
                        // Click "None" in that row
                        r.querySelector('button[onclick*="\'none\'"]').click();
                    }
                });
                selectedTarget = filename;
            } else if (role === 'header') {
                // Clear previous header selections in other rows
                const allRows = document.getElementById('attachmentTableBody').querySelectorAll('tr');
                allRows.forEach(r => {
                    const hBtn = r.querySelector('button[onclick*="\'header\'"]');
                    if (hBtn && hBtn !== btn && hBtn.classList.contains('active')) {
                        r.querySelector('button[onclick*="\'none\'"]').click();
                    }
                });
                selectedHeader = filename;
            } else {
                if (selectedTarget === filename) selectedTarget = null;
                if (selectedHeader === filename) selectedHeader = null;
            }
        }

        function hideAttachmentModal() {
            document.getElementById('attachmentModal').style.display = 'none';
        }

        async function confirmAttachmentSelection() {
            if (!selectedTarget) {
                alert("Please select a Target file to analyze.");
                return;
            }
            hideAttachmentModal();

            // Proceed to final analysis
            const pbContainer = document.getElementById('fullAnalysisProgress');
            pbContainer.style.display = 'block';
            updateProgress(10, "Initializing deep forensics...");

            const formData = new FormData();
            formData.append('session_id', currentSessionId);
            formData.append('analysis_mode', 'attachment');
            formData.append('target_attachment', selectedTarget);
            if (selectedHeader) formData.append('header_attachment', selectedHeader);

            await runFinalAnalysis(formData);
        }

        async function runFinalAnalysis(formData) {
            const pbContainer = document.getElementById('fullAnalysisProgress');
            try {
                updateProgress(30, "Analyzing headers & indicators...");
                const response = await fetch('/api/analyze/email', { method: 'POST', body: formData });
                const data = await response.json();

                updateProgress(50, "Scanning cross-linked reputation...");
                currentAnalysisData = data;
                await renderReport(data);

                if (data.extracted_urls && data.extracted_urls.length > 0) {
                    updateProgress(80, "Queuing sandbox detonations...");
                    const uniqueUrls = [...new Set(data.extracted_urls)].slice(0, 5);
                    currentAnalysisData.sandbox_results = uniqueUrls.map(url => ({ url: url, status: 'pending', score: 0, reasons: [], redirect_chain: [], screenshot_chain: [] }));
                    renderSandboxSection(currentAnalysisData.sandbox_results);

                    let finishedCount = 0;
                    uniqueUrls.map(async (url, idx) => {
                        try {
                            const sbRes = await fetch('/api/analyze/url', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ url: url })
                            });
                            const result = await sbRes.json();
                            currentAnalysisData.sandbox_results[idx] = result;
                            updateSandboxCard(idx, result);
                            recalculateTotalVerdict();
                        } catch (err) {
                            const errorResult = { url: url, status: 'error', score: 0, reasons: ['Sandbox Failed'], redirect_chain: [], screenshot_chain: [] };
                            currentAnalysisData.sandbox_results[idx] = errorResult;
                            updateSandboxCard(idx, errorResult);
                        } finally {
                            finishedCount++;
                            if (finishedCount === uniqueUrls.length) {
                                updateProgress(100, "Forensics complete.");
                                setTimeout(() => pbContainer.style.display = 'none', 3000);
                            }
                        }
                    });
                } else {
                    document.getElementById('noSandboxMsg').style.display = 'block';
                    updateProgress(100, "Forensics complete.");
                    setTimeout(() => pbContainer.style.display = 'none', 3000);
                }
                document.getElementById('downloadBtn').disabled = false;
            } catch (err) {
                alert("Deep analysis failed: " + err);
                pbContainer.style.display = 'none';
            }
        }
    </script>
</body>

</html>